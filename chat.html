<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>دردشة Sheko Store</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Cairo&display=swap');
    body {
      font-family: 'Cairo', sans-serif;
      margin: 0; padding: 0;
      background: #fff;
      color: #222;
      height: 100vh;
      display: flex;
      flex-direction: column;
    }
    header {
      padding: 15px 20px;
      background: #ffb700;
      color: #222;
      font-weight: bold;
      text-align: center;
      font-size: 1.6rem;
      box-shadow: 0 3px 10px #ffb700aa;
    }
    #chatContainer {
      flex: 1;
      padding: 10px 15px;
      overflow-y: auto;
      background: #f9f9f9;
      position: relative;
      border: 1px solid #ddd;
      border-radius: 8px;
    }
    .message {
      display: flex;
      align-items: flex-start;
      margin: 10px 0;
      max-width: 70%;
      padding: 10px 15px;
      border-radius: 12px;
      position: relative;
      animation: fadeInUp 0.4s ease forwards;
      user-select: none;
      box-shadow: 0 1px 3px rgb(0 0 0 / 0.1);
      cursor: default;
    }
    .message.own {
      background: #fff3cd;
      margin-left: auto;
      color: #222;
      flex-direction: row-reverse;
      border: 1px solid #ffecb5;
    }
    .message.other {
      background: #e9ecef;
      color: #222;
      margin-right: auto;
      border: 1px solid #ced4da;
    }
    .avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      margin: 0 10px;
      cursor: pointer;
      flex-shrink: 0;
      border: 2px solid #ffb700;
      object-fit: cover;
      background: #ddd;
    }
    .content {
      flex-grow: 1;
      word-break: break-word;
    }
    #inputContainer {
      display: flex;
      padding: 12px 20px;
      background: #fff8e1;
      border-top: 1px solid #ffd454;
      border-radius: 0 0 8px 8px;
    }
    #messageInput {
      flex-grow: 1;
      padding: 10px 15px;
      border-radius: 30px;
      border: 1px solid #ffc107;
      outline: none;
      font-size: 1rem;
      font-family: 'Cairo', sans-serif;
    }
    #sendBtn {
      background: #ffb700;
      border: none;
      color: #222;
      font-weight: bold;
      font-size: 1.2rem;
      border-radius: 30px;
      padding: 0 20px;
      margin-left: 10px;
      cursor: pointer;
      box-shadow: 0 0 15px #ffb700aa;
      transition: background 0.3s ease;
    }
    #sendBtn:hover:not(:disabled) {
      background: #ffcc33;
    }
    #sendBtn:disabled {
      background: #e0dcdc;
      cursor: not-allowed;
      box-shadow: none;
    }
    /* زر حذف الرسالة */
    .delete-btn-message {
      position: absolute;
      top: 5px;
      left: 5px;
      background: #dc3545;
      border: none;
      color: white;
      padding: 3px 7px;
      border-radius: 5px;
      font-size: 0.85rem;
      cursor: pointer;
      display: none;
      z-index: 10;
    }
    .message.show-delete-btn .delete-btn-message {
      display: block;
    }

    /* نافذة معلومات المستخدم */
    #userInfoModal {
      position: fixed;
      top: 50%; left: 50%;
      transform: translate(-50%, -50%);
      background: #fff;
      border-radius: 15px;
      padding: 25px 20px 20px 20px;
      box-shadow: 0 0 20px #ffb700aa;
      color: #222;
      width: 320px;
      max-width: 90%;
      display: none;
      z-index: 1000;
      text-align: center;
      font-weight: 600;
      font-family: 'Cairo', sans-serif;
    }
    #userInfoModal img {
      width: 90px;
      height: 90px;
      border-radius: 50%;
      border: 3px solid #ffb700;
      margin-bottom: 15px;
      object-fit: cover;
      background: #ddd;
    }
    #userInfoModal h3 {
      margin: 5px 0 10px 0;
      font-size: 1.4rem;
      color: #333;
    }
    #userInfoModal .badges {
      margin-top: 10px;
      display: flex;
      justify-content: center;
      gap: 10px;
      flex-wrap: wrap;
    }
    .badge {
      background: #ffb700;
      color: #222;
      padding: 6px 12px;
      border-radius: 25px;
      font-size: 0.9rem;
      font-weight: bold;
      box-shadow: 0 0 8px #ffb700bb;
      user-select: none;
    }
    #closeUserInfo {
      position: absolute;
      top: 8px;
      right: 12px;
      cursor: pointer;
      font-weight: bold;
      font-size: 1.4rem;
      color: #ffb700;
    }

    @keyframes fadeInUp {
      from {opacity: 0; transform: translateY(10px);}
      to {opacity: 1; transform: translateY(0);}
    }
  </style>
</head>
<body>

<header>دردشة Sheko Store</header>

<div id="chatContainer"></div>

<div id="inputContainer">
  <input type="text" id="messageInput" placeholder="اكتب رسالتك..." autocomplete="off" />
  <button id="sendBtn" disabled>إرسال</button>
</div>

<div id="userInfoModal" role="dialog" aria-modal="true" aria-labelledby="userInfoName">
  <span id="closeUserInfo" title="إغلاق النافذة">&times;</span>
  <img id="userInfoAvatar" src="" alt="صورة المستخدم" />
  <h3 id="userInfoName">اسم المستخدم</h3>
  <div class="badges" id="userBadges"></div>
</div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>

<script>
  // إعداد Firebase
  const firebaseConfig = {
    apiKey: "AIzaSyAYcZ2_RjaI4fjP14QlqbUbL3rWvPPWnas",
    authDomain: "sheko-store.firebaseapp.com",
    databaseURL: "https://sheko-store-default-rtdb.firebaseio.com",
    projectId: "sheko-store",
    storageBucket: "sheko-store.appspot.com",
    messagingSenderId: "113892775847",
    appId: "1:113892775847:web:2aa4c11c3f5dd1d15f0882"
  };
  firebase.initializeApp(firebaseConfig);

  const auth = firebase.auth();
  const db = firebase.database();

  const chatContainer = document.getElementById('chatContainer');
  const messageInput = document.getElementById('messageInput');
  const sendBtn = document.getElementById('sendBtn');

  const userInfoModal = document.getElementById('userInfoModal');
  const userInfoAvatar = document.getElementById('userInfoAvatar');
  const userInfoName = document.getElementById('userInfoName');
  const userBadges = document.getElementById('userBadges');
  const closeUserInfo = document.getElementById('closeUserInfo');

  let currentUser = null;
  let usersData = {}; // بيانات المستخدمين (الاسم، الصورة، الشارات، التصنيف)

  // شارات خاصة للمستخدم المميز
  const specialUserId = "mlifDgEAkKMaOeuUq63cs5NAkV93";
  const specialBadges = [
    "صانع الموقع",
    "الأدمن",
    "المسؤول",
    "الأسطورة",
    "النجم الصاعد"
  ];

  auth.onAuthStateChanged(user => {
    if (!user) {
      location.href = "index.html"; // أو صفحة تسجيل الدخول
      return;
    }
    currentUser = user;
    sendBtn.disabled = false;
    loadAllUsersData();
    listenForMessages();
  });

  // تحميل بيانات المستخدمين من قاعدة البيانات
  function loadAllUsersData() {
    db.ref('users').once('value').then(snapshot => {
      usersData = snapshot.val() || {};
    });
  }

  // الاستماع للرسائل الجديدة
  function listenForMessages() {
    db.ref('chatMessages').on('value', snapshot => {
      const messages = snapshot.val() || {};
      renderMessages(messages);
      scrollChatToBottom();
    });
  }

  // عرض الرسائل
  function renderMessages(messages) {
    chatContainer.innerHTML = '';
    Object.keys(messages).forEach(key => {
      const msg = messages[key];
      const isOwn = msg.uid === currentUser.uid;

      // بيانات المرسل من usersData، اسم المستخدم (name) وصورة (photoURL)
      const user = usersData[msg.uid] || {};
      const name = user.name || msg.email || "مستخدم مجهول";
      const avatar = user.photoURL || "https://i.pravatar.cc/40?u=" + msg.uid;

      // عنصر الرسالة
      const messageDiv = document.createElement('div');
      messageDiv.classList.add('message');
      messageDiv.classList.add(isOwn ? 'own' : 'other');
      messageDiv.dataset.key = key;

      messageDiv.innerHTML = `
        <img src="${avatar}" alt="صورة ${name}" class="avatar" data-uid="${msg.uid}" />
        <div class="content">
          <strong>${escapeHtml(name)}</strong>
          <div>${escapeHtml(msg.text)}</div>
        </div>
        <button class="delete-btn-message" title="حذف الرسالة">حذف</button>
      `;

      chatContainer.appendChild(messageDiv);

      // عند الضغط على صورة المستخدم تظهر نافذة معلوماته
      messageDiv.querySelector('.avatar').addEventListener('click', () => {
        showUserInfo(msg.uid);
      });

      // إضافة دعم زر حذف عند الضغط المطول
      addDeleteButtonHandler(messageDiv, key, msg.uid);
    });
  }

  // فلتر كلمات سيئة (يمكن توسعته)
  const badWords = ['سيء', 'كلمةسيئة', 'شتم'];
  function containsBadWords(text) {
    const lowered = text.toLowerCase();
    return badWords.some(word => lowered.includes(word));
  }

  // إرسال رسالة
  function sendMessage() {
    let text = messageInput.value.trim();
    if (!text) return;

    if (containsBadWords(text)) {
      alert("لا يمكن استخدام كلمات مسيئة في الرسائل");
      return;
    }

    const message = {
      uid: currentUser.uid,
      email: currentUser.email || "غير معروف",
      text: text,
      timestamp: Date.now()
    };

    db.ref('chatMessages').push(message).then(() => {
      messageInput.value = '';
      scrollChatToBottom();
    });
  }

  // زر إرسال
  sendBtn.addEventListener('click', () => {
    sendMessage();
  });

  // إرسال عند الضغط Enter (دون Shift)
  messageInput.addEventListener('keypress', e => {
    if(e.key === 'Enter' && !e.shiftKey){
      e.preventDefault();
      sendMessage();
    }
  });

  // تمرير الدردشة لأسفل
  function scrollChatToBottom() {
    chatContainer.scrollTop = chatContainer.scrollHeight;
  }

  // إظهار نافذة معلومات المستخدم مع الشارات
  function showUserInfo(uid) {
    const user = usersData[uid] || {};
    userInfoAvatar.src = user.photoURL || "https://i.pravatar.cc/80?u=" + uid;
    userInfoName.textContent = user.name || user.email || "مستخدم مجهول";

    userBadges.innerHTML = '';
    if(uid === specialUserId){
      specialBadges.forEach(badge => {
        const span = document.createElement('span');
        span.className = 'badge';
        span.textContent = badge;
        userBadges.appendChild(span);
      });
    } else if (user.badges && Array.isArray(user.badges)) {
      user.badges.forEach(badge => {
        const span = document.createElement('span');
        span.className = 'badge';
        span.textContent = badge;
        userBadges.appendChild(span);
      });
    }

    userInfoModal.style.display = 'block';
  }

  closeUserInfo.addEventListener('click', () => {
    userInfoModal.style.display = 'none';
  });

  // زر حذف يظهر عند الضغط المطول
  function addDeleteButtonHandler(messageDiv, messageKey, messageUid) {
    let timer = null;
    const deleteBtn = messageDiv.querySelector('.delete-btn-message');

    messageDiv.addEventListener('mousedown', () => {
      timer = setTimeout(() => {
        messageDiv.classList.add('show-delete-btn');
      }, 700);
    });

    messageDiv.addEventListener('mouseup', () => {
      clearTimeout(timer);
    });

    messageDiv.addEventListener('mouseleave', () => {
      clearTimeout(timer);
    });

    deleteBtn.addEventListener('click', (e) => {
      e.stopPropagation();
      if(currentUser.uid === messageUid || currentUser.uid === specialUserId){
        if(confirm("هل تريد حذف هذه الرسالة؟")){
          db.ref('chatMessages/' + messageKey).remove();
        }
      } else {
        alert("لا يمكنك حذف هذه الرسالة");
      }
      messageDiv.classList.remove('show-delete-btn');
    });
  }
</script>

</body>
</html>
