<!DOCTYPE html><html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>الدردشة - Sheko Store</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Cairo', sans-serif;
      background: #fff;
      margin: 0;
      padding: 0;
      height: 100vh;
      display: flex;
      flex-direction: column;
    }
    header {
      background: #ffb700;
      padding: 15px;
      font-weight: bold;
      font-size: 1.5rem;
      box-shadow: 0 2px 5px rgba(0,0,0,0.2);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .online-counter {
      display: flex;
      flex-direction: column;
      align-items: center;
      margin-left: 10px;
      font-size: 0.9rem;
      color: #222;
    }
    .online-counter i {
      font-size: 1.4rem;
    }
    #chatContainer {
      flex: 1;
      overflow-y: auto;
      padding: 10px;
    }
    .message {
      display: flex;
      align-items: flex-start;
      margin-bottom: 10px;
    }
    .avatar {
      margin-left: 10px;
      width: 48px;
      height: 48px;
      border-radius: 50%;
      overflow: hidden;
      flex-shrink: 0;
    }
    .avatar img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      cursor: pointer;
    }
    .content {
      background: #ffb700;
      color: #222;
      padding: 10px;
      border-radius: 15px;
      max-width: 70%;
      position: relative;
    }
    .own .content {
      background: #222;
      color: #ffb700;
      margin-left: auto;
      margin-right: 10px;
    }
    .username {
      font-weight: bold;
      font-size: 0.85rem;
      margin-bottom: 5px;
    }
    .timestamp {
      font-size: 0.75rem;
      color: #666;
      margin-top: 5px;
      text-align: left;
    }
    .delete-btn {
      background: #dc3545;
      border: none;
      color: white;
      font-weight: bold;
      padding: 4px 10px;
      margin-right: 5px;
      border-radius: 6px;
      cursor: pointer;
    }
    #inputContainer {
      display: flex;
      padding: 10px;
      background: #eee;
      align-items: center;
    }
    #messageInput {
      flex: 1;
      padding: 10px;
      border-radius: 20px;
      border: 1px solid #ccc;
      font-size: 1rem;
      outline: none;
    }
    #sendBtn {
      background: #ffb700;
      border: none;
      color: #222;
      font-weight: bold;
      padding: 10px 20px;
      margin-left: 10px;
      border-radius: 20px;
      cursor: pointer;
    }
  </style>
  <script src="https://kit.fontawesome.com/a076d05399.js" crossorigin="anonymous"></script>
</head>
<body>
  <header>
    <div>دردشة Sheko Store</div>
    <div class="online-counter">
      <i class="fas fa-eye"></i>
      <span id="onlineCount">0</span>
    </div>
  </header>
  <div id="chatContainer"></div>
  <div id="inputContainer">
    <input type="text" id="messageInput" placeholder="اكتب رسالتك هنا...">
    <button id="sendBtn" disabled>إرسال</button>
  </div>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
  <script>
    const firebaseConfig = { /* بياناتك */ };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.database();const chatContainer = document.getElementById('chatContainer');
const messageInput = document.getElementById('messageInput');
const sendBtn = document.getElementById('sendBtn');
const onlineCount = document.getElementById('onlineCount');

let currentUser = null;
const usersData = {};

auth.onAuthStateChanged(user => {
  if (user) {
    currentUser = user;
    sendBtn.disabled = false;
    const userStatusRef = db.ref(`presence/${user.uid}`);
    userStatusRef.set(true);
    userStatusRef.onDisconnect().remove();

    db.ref('presence').on('value', snap => {
      const val = snap.val() || {};
      onlineCount.textContent = Object.keys(val).length;
    });

    db.ref('chatMessages').on('value', snap => {
      const messages = snap.val() || {};
      chatContainer.innerHTML = '';
      Object.entries(messages).forEach(([id, msg]) => {
        const msgDiv = document.createElement('div');
        msgDiv.className = 'message';
        if (msg.uid === currentUser.uid) msgDiv.classList.add('own');

        const avatar = document.createElement('div');
        avatar.className = 'avatar';
        const img = document.createElement('img');
        img.src = usersData[msg.uid]?.photoURL || 'https://via.placeholder.com/48';
        avatar.appendChild(img);

        const content = document.createElement('div');
        content.className = 'content';

        const userNameDiv = document.createElement('div');
        userNameDiv.className = 'username';
        userNameDiv.textContent = usersData[msg.uid]?.username || msg.email || 'مستخدم';

        const textDiv = document.createElement('div');
        textDiv.textContent = msg.text;

        const timeDiv = document.createElement('div');
        timeDiv.className = 'timestamp';
        timeDiv.textContent = new Date(msg.timestamp).toLocaleString('ar-EG');

        content.appendChild(userNameDiv);
        content.appendChild(textDiv);
        content.appendChild(timeDiv);

        msgDiv.appendChild(avatar);
        msgDiv.appendChild(content);

        if (msg.uid === currentUser.uid) {
          const delBtn = document.createElement('button');
          delBtn.className = 'delete-btn';
          delBtn.textContent = 'حذف';
          delBtn.onclick = () => {
            if (confirm('تأكيد حذف الرسالة؟')) {
              db.ref(`chatMessages/${id}`).remove();
            }
          };
          msgDiv.appendChild(delBtn);
        }

        chatContainer.appendChild(msgDiv);
      });
      chatContainer.scrollTop = chatContainer.scrollHeight;
    });
  } else {
    location.href = 'index.html';
  }
});

messageInput.addEventListener('input', () => {
  sendBtn.disabled = messageInput.value.trim().length === 0;
});

sendBtn.addEventListener('click', () => {
  const text = messageInput.value.trim();
  if (!text) return;

  db.ref('chatMessages').push({
    uid: currentUser.uid,
    email: currentUser.email,
    text: text,
    timestamp: Date.now()
  });

  messageInput.value = '';
  sendBtn.disabled = true;
});

  </script>
</body>
</html>
