<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>الدردشة - Sheko Store</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body {
      font-family: 'Cairo', sans-serif;
      background: #fff;
      color: #222;
      margin: 0;
      padding: 0;
      display: flex;
      flex-direction: column;
      height: 100vh;
    }
    header {
      background: #ffb700;
      color: #222;
      padding: 15px;
      text-align: center;
      font-weight: bold;
      font-size: 1.5rem;
      box-shadow: 0 2px 5px rgba(0,0,0,0.2);
      display: flex;
      justify-content: center;
      align-items: center;
    }
    #chatContainer {
      flex: 1;
      display: flex;
      flex-direction: column;
      padding: 10px;
      overflow-y: auto;
      background: linear-gradient(45deg, #fffbdb, #fff);
    }
    .message {
      display: flex;
      margin-bottom: 12px;
      align-items: flex-start;
    }
    .message .avatar {
      width: 48px;
      height: 48px;
      border-radius: 50%;
      margin-left: 10px;
      cursor: pointer;
      background: linear-gradient(135deg, #fff7a6, #ffdf1a);
      color: #bfa900;
      font-weight: 900;
      font-size: 1.5rem;
      display: flex;
      justify-content: center;
      align-items: center;
      box-shadow: 0 0 10px #ffb700aa, inset 0 0 5px #ffd700aa;
      user-select: none;
      transition: box-shadow 0.3s ease;
      flex-shrink: 0;
      overflow: hidden;
    }
    .message .avatar img {
      width: 48px;
      height: 48px;
      border-radius: 50%;
      object-fit: cover;
      display: block;
    }
    .message .avatar:hover {
      box-shadow: 0 0 25px #ffd700ff, inset 0 0 12px #fffecbaa;
    }
    .message .content {
      background: #ffb700;
      color: #222;
      padding: 8px 12px;
      border-radius: 15px;
      max-width: 70%;
      word-break: break-word;
      position: relative;
      font-size: 1rem;
      font-weight: 600;
      box-shadow: 0 2px 5px rgba(0,0,0,0.15);
      display: flex;
      flex-direction: column;
    }
    .message.own .content {
      background: #222;
      color: #ffb700;
      margin-left: auto;
      margin-right: 10px;
    }
    .message .username {
      font-weight: 700;
      margin-bottom: 3px;
      color: #444;
      font-size: 0.85rem;
    }
    .message .timestamp {
      font-size: 0.7rem;
      color: #666;
      margin-top: 4px;
      align-self: flex-end;
    }
    #inputContainer {
      display: flex;
      padding: 10px;
      background: #eee;
      border-top: 1px solid #ccc;
      align-items: center;
    }
    #messageInput {
      flex: 1;
      padding: 10px;
      border-radius: 20px;
      border: 1px solid #ccc;
      font-size: 1rem;
      outline: none;
      transition: border-color 0.3s ease;
    }
    #messageInput:focus {
      border-color: #ffb700;
    }
    #sendBtn {
      background: #ffb700;
      border: none;
      color: #222;
      font-weight: bold;
      padding: 10px 20px;
      margin-left: 10px;
      border-radius: 20px;
      cursor: pointer;
      font-size: 1rem;
      transition: background 0.3s ease;
    }
    #sendBtn:disabled {
      background: #ccc;
      cursor: not-allowed;
    }

    /* مودال النافذة */
    #userModal {
      display: none;
      position: fixed;
      z-index: 9999;
      left: 0; top: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.5);
      justify-content: center;
      align-items: center;
    }
    #userModalContent {
      background: #fff;
      border-radius: 15px;
      max-width: 360px;
      width: 90%;
      padding: 20px;
      text-align: center;
      position: relative;
      box-shadow: 0 4px 20px rgba(0,0,0,0.25);
      font-weight: 600;
      color: #222;
      user-select: none;
    }
    #userModalContent .userImagePlaceholder {
      width: 120px;
      height: 120px;
      border-radius: 50%;
      background: linear-gradient(135deg, #fff7a6, #ffdf1a);
      margin: 0 auto 15px;
      display: flex;
      justify-content: center;
      align-items: center;
      color: #bfa900;
      font-weight: 900;
      font-size: 5rem;
      box-shadow:
        0 0 15px #ffb700aa,
        inset 0 0 8px #ffd700aa;
      animation: imageSlideInOut 4s ease-in-out infinite;
      overflow: hidden;
    }
    #userModalContent .userImagePlaceholder img {
      width: 120px;
      height: 120px;
      border-radius: 50%;
      object-fit: cover;
      display: block;
    }
    #userModalContent h2 {
      margin: 0 0 10px 0;
      font-size: 2rem;
      color: #ffb700;
      font-weight: 900;
      text-shadow:
        0 0 8px #ffd700,
        0 0 20px #ffbf00,
        0 0 30px #e6ac00;
      animation: userNamePulse 3s ease-in-out infinite;
    }
    #closeModalBtn {
      position: absolute;
      top: 10px;
      left: 10px;
      cursor: pointer;
      font-size: 1.5rem;
      font-weight: bold;
      background: none;
      border: none;
      color: #ffb700;
      transition: color 0.3s ease;
    }
    #closeModalBtn:hover {
      color: #222;
    }
    #badgesContainer {
      display: flex;
      justify-content: center;
      gap: 15px;
      margin-top: 15px;
      flex-wrap: wrap;
    }
    .badge {
      font-size: 1.1rem;
      color: #bfa900;
      font-weight: bold;
      text-shadow:
        0 0 5px #fff8b3,
        0 0 10px #ffd700,
        0 0 20px #ffbf00,
        0 0 30px #e6ac00;
      animation: badgeGlow 3s ease-in-out infinite;
      padding: 6px 12px;
      border-radius: 12px;
      background: linear-gradient(45deg, #fff7a6, #ffdf1a);
      box-shadow: 0 0 10px #ffcc00aa inset;
      user-select: none;
      cursor: default;
    }
    #noBadgesText {
      color: #888;
      font-style: italic;
      margin-top: 15px;
      user-select: none;
    }

    /* حركات وتأثيرات الشارات */
    @keyframes badgeGlow {
      0%, 100% {
        text-shadow:
          0 0 5px #fff8b3,
          0 0 10px #ffd700,
          0 0 20px #ffbf00,
          0 0 30px #e6ac00;
        color: #bfa900;
      }
      50% {
        text-shadow:
          0 0 10px #fff8b3,
          0 0 20px #ffd700,
          0 0 30px #ffbf00,
          0 0 40px #e6ac00;
        color: #fff8b3;
      }
    }

    /* تأثير اسم المستخدم في المودال */
    @keyframes userNamePulse {
      0%, 100% {
        color: #ffb700;
        text-shadow:
          0 0 8px #ffd700,
          0 0 20px #ffbf00,
          0 0 30px #e6ac00;
        transform: scale(1) translateY(0);
      }
      50% {
        color: #fff4a3;
        text-shadow:
          0 0 15px #fff4a3,
          0 0 30px #ffdb44,
          0 0 45px #ffb700;
        transform: scale(1.05) translateY(-4px);
      }
    }

    /* حركة صورة المستخدم */
    @keyframes imageSlideInOut {
      0%, 100% {
        transform: translateX(0);
        box-shadow:
          0 0 10px #ffb700aa,
          inset 0 0 5px #ffd700aa;
      }
      50% {
        transform: translateX(10px);
        box-shadow:
          0 0 25px #ffd700ff,
          inset 0 0 12px #fffecbaa;
      }
    }

    /* زر حذف الرسائل */
    .delete-btn {
      margin-right: 10px;
      padding: 4px 10px;
      border-radius: 6px;
      border: none;
      cursor: pointer;
      background-color: #dc3545;
      color: white;
      font-weight: bold;
      align-self: center;
    }
  </style>
</head>
<body>
  <header>
    دردشة Sheko Store
  </header>

  <div id="chatContainer"></div>

  <div id="inputContainer">
    <input type="text" id="messageInput" placeholder="اكتب رسالتك هنا..." autocomplete="off" />
    <button id="sendBtn" disabled>إرسال</button>
  </div>

  <!-- نافذة عرض بيانات المستخدم -->
  <div id="userModal">
    <div id="userModalContent">
      <button id="closeModalBtn" title="إغلاق">&times;</button>
      <div class="userImagePlaceholder" id="modalUserImagePlaceholder">?</div>
      <h2 id="modalUserName"></h2>
      <div id="badgesContainer"></div>
      <div id="noBadgesText" style="display:none;">لم يحصل على شارات بعد</div>
    </div>
  </div>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-storage-compat.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyAYcZ2_RjaI4fjP14QlqbUbL3rWvPPWnas",
      authDomain: "sheko-store.firebaseapp.com",
      databaseURL: "https://sheko-store-default-rtdb.firebaseio.com",
      projectId: "sheko-store",
      storageBucket: "sheko-store.appspot.com",
      messagingSenderId: "113892775847",
      appId: "1:113892775847:web:2aa4c11c3f5dd1d15f0882"
    };
    firebase.initializeApp(firebaseConfig);

    const auth = firebase.auth();
    const db = firebase.database();
    const storage = firebase.storage();

    const chatContainer = document.getElementById('chatContainer');
    const messageInput = document.getElementById('messageInput');
    const sendBtn = document.getElementById('sendBtn');

    // مودال العناصر
    const userModal = document.getElementById('userModal');
    const closeModalBtn = document.getElementById('closeModalBtn');
    const modalUserImagePlaceholder = document.getElementById('modalUserImagePlaceholder');
    const modalUserName = document.getElementById('modalUserName');
    const badgesContainer = document.getElementById('badgesContainer');
    const noBadgesText = document.getElementById('noBadgesText');

    let currentUser = null;
    let usersData = {};

    // UID خاص بالمستخدم المسؤول والشارات الخاصة به (نصوص فقط)
    const specialUID = "mlifDgEAkKMaOeuUq63cs5NAkV93";
    const specialBadges = [
      "الأدمن",
      "المطور",
      "الأسطورة",
      "VIP 10",
      "المؤسس"
    ];

    // كلمات ممنوعة
    const bannedWords = ["سيء", "سيئة", "كلمة_سيئة"];

    auth.onAuthStateChanged(user => {
      if (!user) {
        location.href = "index.html";
        return;
      }
      currentUser = user;
      sendBtn.disabled = false;
      loadAllUsersData();
      listenForMessages();
    });

    // تحميل بيانات جميع المستخدمين من قاعدة بيانات Firebase
    function loadAllUsersData() {
      db.ref('users').on('value', snapshot => {
        usersData = snapshot.val() || {};
      });
    }

    // تنسيق الطابع الزمني لعرض الوقت والتاريخ
    function formatTimestamp(ts) {
      const date = new Date(ts);
      return date.toLocaleString('ar-EG', {
        year: 'numeric',
        month: 'short',
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
      });
    }

    // الاستماع للرسائل الجديدة من قاعدة بيانات Firebase
    function listenForMessages() {
      db.ref('chatMessages').on('value', snapshot => {
        const messages = snapshot.val() || {};
        renderMessages(messages);
        scrollChatToBottom();
      });
    }

    // جلب رابط صورة المستخدم من التخزين أو إظهار أول حرف إذا لم توجد صورة
    async function getUserPhotoURL(uid, fallbackChar) {
      if (!usersData[uid] || !usersData[uid].photoURL) {
        return null;
      }
      try {
        const photoURL = usersData[uid].photoURL;
        // افترض أن photoURL هو رابط مباشر أو رابط تخزين firebase
        // إذا هو رابط تخزين Firebase، استخرج الرابط النهائي
        if (photoURL.startsWith('gs://') || photoURL.startsWith('user_photos/')) {
          const url = await storage.ref(photoURL).getDownloadURL();
          return url;
        }
        return photoURL;
      } catch (error) {
        console.warn('خطأ في تحميل صورة المستخدم:', error);
        return null;
      }
    }

    // عرض الرسائل في الصفحة
    async function renderMessages(messages) {
      chatContainer.innerHTML = '';
      for (const key of Object.keys(messages)) {
        const msg = messages[key];
        const isOwn = msg.uid === currentUser.uid;
        const userData = usersData[msg.uid] || {};
        const userName = userData.username || msg.email || "مستخدم مجهول";

        const msgDiv = document.createElement('div');
        msgDiv.classList.add('message');
        if (isOwn) msgDiv.classList.add('own');

        // تحضير صورة المستخدم أو أول حرف اسمه
        const avatar = document.createElement('div');
        avatar.className = 'avatar';
        avatar.title = userName;
        avatar.addEventListener('click', () => showUserModal(msg.uid));

        const photoURL = await getUserPhotoURL(msg.uid, userName.charAt(0).toUpperCase());

        if (photoURL) {
          const img = document.createElement('img');
          img.src = photoURL;
          img.alt = userName;
          avatar.appendChild(img);
        } else {
          avatar.textContent = (userName.trim().charAt(0) || "?").toUpperCase();
        }

        // المحتوى: اسم المستخدم + نص الرسالة + التاريخ
        const content = document.createElement('div');
        content.classList.add('content');

        const userNameDiv = document.createElement('div');
        userNameDiv.className = 'username';
        userNameDiv.textContent = userName;

        const textDiv = document.createElement('div');
        textDiv.textContent = msg.text;

        const timeDiv = document.createElement('div');
        timeDiv.className = 'timestamp';
        timeDiv.textContent = formatTimestamp(msg.timestamp);

        content.appendChild(userNameDiv);
        content.appendChild(textDiv);
        content.appendChild(timeDiv);

        msgDiv.appendChild(avatar);
        msgDiv.appendChild(content);

        // زر حذف للرسائل للمستخدم نفسه أو الأدمن
        if (isOwn || currentUser.uid === specialUID) {
          const delBtn = document.createElement('button');
          delBtn.textContent = 'حذف';
          delBtn.className = 'delete-btn';
          delBtn.title = "حذف الرسالة";
          delBtn.addEventListener('click', () => {
            if (confirm("هل تريد حذف هذه الرسالة؟")) {
              db.ref(`chatMessages/${key}`).remove();
            }
          });
          msgDiv.appendChild(delBtn);
        }

        chatContainer.appendChild(msgDiv);
      }
    }

    // تمرير الشات لأسفل تلقائياً
    function scrollChatToBottom() {
      chatContainer.scrollTop = chatContainer.scrollHeight;
    }

// التحقق من الكلمات الممنوعة
    function containsBannedWords(text) {
      const lowerText = text.toLowerCase();
      return bannedWords.some(word => lowerText.includes(word));
    }

    // إرسال الرسالة
    sendBtn.addEventListener('click', () => {
      const text = messageInput.value.trim();
      if (!text) return;

      if (containsBannedWords(text)) {
        alert("الرسالة تحتوي على كلمات ممنوعة، الرجاء تعديلها.");
        return;
      }

      const newMsg = {
        uid: currentUser.uid,
        email: currentUser.email,
        text: text,
        timestamp: Date.now()
      };

      db.ref('chatMessages').push(newMsg)
        .then(() => {
          messageInput.value = '';
          sendBtn.disabled = true;
          scrollChatToBottom();
        })
        .catch(err => {
          alert("حدث خطأ أثناء إرسال الرسالة.");
          console.error(err);
        });
    });

    messageInput.addEventListener('input', () => {
      sendBtn.disabled = messageInput.value.trim().length === 0;
    });

    // عرض نافذة بيانات المستخدم عند الضغط على صورة أو حرف الاسم
    async function showUserModal(uid) {
      if (!usersData[uid]) {
        alert("لا توجد بيانات لهذا المستخدم.");
        return;
      }
      const user = usersData[uid];
      modalUserName.textContent = user.username || user.email || "مستخدم مجهول";
      badgesContainer.innerHTML = '';
      noBadgesText.style.display = 'none';

      // جلب صورة المستخدم أو أول حرف اسمه
      const photoURL = await getUserPhotoURL(uid, modalUserName.textContent.charAt(0).toUpperCase());

      if (photoURL) {
        modalUserImagePlaceholder.innerHTML = `<img src="${photoURL}" alt="${modalUserName.textContent}">`;
      } else {
        modalUserImagePlaceholder.textContent = modalUserName.textContent.charAt(0).toUpperCase();
      }

      // عرض الشارات (إن وجدت)
      if (uid === specialUID) {
        specialBadges.forEach(badgeText => {
          const badge = document.createElement('div');
          badge.className = 'badge';
          badge.textContent = badgeText;
          badgesContainer.appendChild(badge);
        });
      } else if (user.badges && Array.isArray(user.badges) && user.badges.length > 0) {
        user.badges.forEach(badgeText => {
          const badge = document.createElement('div');
          badge.className = 'badge';
          badge.textContent = badgeText;
          badgesContainer.appendChild(badge);
        });
      } else {
        noBadgesText.style.display = 'block';
      }

      userModal.style.display = 'flex';
    }

    // إغلاق نافذة بيانات المستخدم
    closeModalBtn.addEventListener('click', () => {
      userModal.style.display = 'none';
    });

    // إغلاق المودال عند النقر خارج المحتوى
    userModal.addEventListener('click', (e) => {
      if (e.target === userModal) {
        userModal.style.display = 'none';
      }
    });

  </script>
</body>
</html>
