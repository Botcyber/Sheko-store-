<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>دردشة Sheko Store</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Cairo&display=swap');
    body {
      font-family: 'Cairo', sans-serif;
      margin: 0; padding: 0;
      background: linear-gradient(135deg, #222 0%, #111 100%);
      color: #eee;
      height: 100vh;
      display: flex;
      flex-direction: column;
    }
    header {
      padding: 10px 20px;
      background: rgba(255, 183, 0, 0.9);
      color: #222;
      font-weight: bold;
      text-align: center;
      font-size: 1.5rem;
      box-shadow: 0 3px 10px #ffb700aa;
    }
    #chatContainer {
      flex: 1;
      padding: 10px;
      overflow-y: auto;
      background: rgba(0,0,0,0.6);
      position: relative;
      backdrop-filter: blur(6px);
    }
    .message {
      display: flex;
      margin: 10px 0;
      max-width: 70%;
      padding: 8px 12px;
      border-radius: 12px;
      position: relative;
      animation: fadeInUp 0.4s ease forwards;
    }
    .message.own {
      background: #ffb700cc;
      margin-left: auto;
      color: #222;
    }
    .message.other {
      background: #444;
      color: #eee;
      margin-right: auto;
    }
    .avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      margin: 0 10px;
      cursor: pointer;
      flex-shrink: 0;
      border: 2px solid #ffb700;
    }
    .content {
      flex-grow: 1;
      word-break: break-word;
    }
    #inputContainer {
      display: flex;
      padding: 10px 20px;
      background: rgba(0,0,0,0.8);
    }
    #messageInput {
      flex-grow: 1;
      padding: 10px 15px;
      border-radius: 30px;
      border: none;
      outline: none;
      font-size: 1rem;
      font-family: 'Cairo', sans-serif;
    }
    #sendBtn {
      background: #ffb700;
      border: none;
      color: #222;
      font-weight: bold;
      font-size: 1.2rem;
      border-radius: 30px;
      padding: 0 20px;
      margin-left: 10px;
      cursor: pointer;
      box-shadow: 0 0 15px #ffb700aa;
      transition: background 0.3s ease;
    }
    #sendBtn:hover:not(:disabled) {
      background: #ffcc33;
    }
    #sendBtn:disabled {
      background: #555;
      cursor: not-allowed;
      box-shadow: none;
    }
    /* نافذة معلومات المستخدم */
    #userInfoModal {
      position: fixed;
      top: 50%; left: 50%;
      transform: translate(-50%, -50%);
      background: #222;
      border-radius: 15px;
      padding: 20px;
      box-shadow: 0 0 20px #ffb700aa;
      color: #eee;
      width: 300px;
      max-width: 90%;
      display: none;
      z-index: 1000;
      text-align: center;
    }
    #userInfoModal img {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      border: 2px solid #ffb700;
      margin-bottom: 10px;
    }
    #userInfoModal h3 {
      margin: 5px 0;
    }
    #userInfoModal .badges {
      margin-top: 10px;
      display: flex;
      justify-content: center;
      gap: 8px;
      flex-wrap: wrap;
    }
    .badge {
      background: #ffb700;
      color: #222;
      padding: 5px 10px;
      border-radius: 20px;
      font-size: 0.85rem;
      font-weight: bold;
      box-shadow: 0 0 8px #ffb700bb;
    }
    #closeUserInfo {
      position: absolute;
      top: 8px;
      right: 12px;
      cursor: pointer;
      font-weight: bold;
      font-size: 1.2rem;
      color: #ffb700;
    }

    @keyframes fadeInUp {
      from {opacity: 0; transform: translateY(10px);}
      to {opacity: 1; transform: translateY(0);}
    }
  </style>
</head>
<body>

<header>دردشة Sheko Store</header>

<div id="chatContainer"></div>

<div id="inputContainer">
  <input type="text" id="messageInput" placeholder="اكتب رسالتك..." autocomplete="off" />
  <button id="sendBtn" disabled>إرسال</button>
</div>

<div id="userInfoModal">
  <span id="closeUserInfo">&times;</span>
  <img id="userInfoAvatar" src="" alt="صورة المستخدم" />
  <h3 id="userInfoName">اسم المستخدم</h3>
  <div class="badges" id="userBadges"></div>
</div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>

<script>
  // إعداد Firebase
  const firebaseConfig = {
    apiKey: "AIzaSyAYcZ2_RjaI4fjP14QlqbUbL3rWvPPWnas",
    authDomain: "sheko-store.firebaseapp.com",
    databaseURL: "https://sheko-store-default-rtdb.firebaseio.com",
    projectId: "sheko-store",
    storageBucket: "sheko-store.appspot.com",
    messagingSenderId: "113892775847",
    appId: "1:113892775847:web:2aa4c11c3f5dd1d15f0882"
  };
  firebase.initializeApp(firebaseConfig);

  const auth = firebase.auth();
  const db = firebase.database();

  const chatContainer = document.getElementById('chatContainer');
  const messageInput = document.getElementById('messageInput');
  const sendBtn = document.getElementById('sendBtn');

  const userInfoModal = document.getElementById('userInfoModal');
  const userInfoAvatar = document.getElementById('userInfoAvatar');
  const userInfoName = document.getElementById('userInfoName');
  const userBadges = document.getElementById('userBadges');
  const closeUserInfo = document.getElementById('closeUserInfo');

  let currentUser = null;
  let usersData = {}; // لتخزين بيانات المستخدمين (الاسم، الصورة، الشارات، التصنيف)

  // شارات خاصة للمستخدم المعين
  const specialUserId = "mlifDgEAkKMaOeuUq63cs5NAkV93";
  const specialBadges = [
    "صانع الموقع",
    "الأدمن",
    "المسؤول",
    "الأسطورة",
    "النجم الصاعد"
  ];

  auth.onAuthStateChanged(user => {
    if (!user) {
      location.href = "index.html"; // أو صفحة تسجيل الدخول
      return;
    }
    currentUser = user;
    sendBtn.disabled = false;
    loadAllUsersData();
    listenForMessages();
  });

  // تحميل بيانات جميع المستخدمين (الاسم، الصورة، الشارات، التصنيف)
  function loadAllUsersData() {
    db.ref('users').once('value').then(snapshot => {
      usersData = snapshot.val() || {};
    });
  }

  // الاستماع للرسائل الجديدة
  function listenForMessages() {
    db.ref('chatMessages').on('value', snapshot => {
      const messages = snapshot.val() || {};
      renderMessages(messages);
      scrollChatToBottom();
    });
  }

  // عرض الرسائل
  function renderMessages(messages) {
    chatContainer.innerHTML = '';
    Object.keys(messages).forEach(key => {
      const msg = messages[key];
      const isOwn = msg.uid === currentUser.uid;

      // بيانات المرسل
      const user = usersData[msg.uid] || {};
      const name = user.name || msg.email || "مستخدم مجهول";
      const avatar = user.photoURL || "https://i.pravatar.cc/40?u=" + msg.uid;

      // الشارات
      let badgesHtml = "";
      if(msg.uid === specialUserId){
        badgesHtml = specialBadges.map(b => `<span class="badge">${b}</span>`).join('');
      } else if(user.badges && Array.isArray(user.badges)) {
        badgesHtml = user.badges.map(b => `<span class="badge">${b}</span>`).join('');
      }

      // عنصر الرسالة
      const messageDiv = document.createElement('div');
      messageDiv.classList.add('message');
      messageDiv.classList.add(isOwn ? 'own' : 'other');
      messageDiv.dataset.key = key;

      // المحتوى
      messageDiv.innerHTML = `
        <img src="${avatar}" alt="avatar" class="avatar" data-uid="${msg.uid}" />
        <div class="content">
          <strong>${name}</strong> ${badgesHtml ? `<div>${badgesHtml}</div>` : ''}
          <div>${escapeHtml(msg.text)}</div>
        </div>
      `;

      chatContainer.appendChild(messageDiv);

      // دعم حذف الرسائل بالضغط المطول
      addDeleteHandler(messageDiv, key, msg.uid);

      // عند الضغط على الصورة تظهر نافذة معلومات المستخدم
      messageDiv.querySelector('.avatar').addEventListener('click', () => {
        showUserInfo(msg.uid);
      });
    });
  }

  // الهروب من النص لتجنب كلمات سيئة (يمكنك إضافة فلتر هنا)
  function escapeHtml(text) {
    const map = {
      '&': '&amp;',
      '<': '&lt;',
      '>': '&gt;',
      '"': '&quot;',
      "'": '&#039;'
    };
    return text.replace(/[&<>"']/g, m => map[m]);
  }

  // زر إرسال رسالة
  sendBtn.addEventListener('click', () => {
    sendMessage();
  });

  // إرسال رسالة عند الضغط Enter
  messageInput.addEventListener('keypress', e => {
    if(e.key === 'Enter' && !e.shiftKey){
      e.preventDefault();
      sendMessage();
    }
  });

  // إرسال رسالة
  function sendMessage() {
    let text = messageInput.value.trim();
    if (!text) return;

    if (containsBadWords(text)) {
      alert("لا يمكن استخدام كلمات مسيئة في الرسائل");
      return;
    }

    const message = {
      uid: currentUser.uid,
      email: currentUser.email || "غير معروف",
      text: text,
      timestamp: Date.now()
    };

    db.ref('chatMessages').push(message).then(() => {
      messageInput.value = '';
      scrollChatToBottom();
    });
  }

  // فلتر للكلمات السيئة (مثال بسيط، يمكن تطويره)
  const badWords = ['سيء', 'كلمةسيئة', 'شتم']; // أضف كلمات أكثر حسب الحاجة
  function containsBadWords(text) {
    const lowered = text.toLowerCase();
    return badWords.some(word => lowered.includes(word));
  }

  // تمرير الدردشة للآخر تلقائياً
  function scrollChatToBottom() {
    chatContainer.scrollTop = chatContainer.scrollHeight;
  }

  // عرض نافذة معلومات المستخدم
  function showUserInfo(uid) {
    const user = usersData[uid] || {};
    userInfoAvatar.src = user.photoURL || "https://i.pravatar.cc/80?u=" + uid;
    userInfoName.textContent = user.name || user.email || "مستخدم مجهول";

    // الشارات الخاصة
    userBadges.innerHTML = '';
    if(uid === specialUserId){
      specialBadges.forEach(b => {
        const span = document.createElement('span');
        span.className = 'badge';
        span.textContent = b;
        userBadges.appendChild(span);
      });
    } else if(user.badges && Array.isArray(user.badges)) {
      user.badges.forEach(b => {
        const span = document.createElement('span');
        span.className = 'badge';
        span.textContent = b;
        userBadges.appendChild(span);
      });
    }
    userInfoModal.style.display = 'block';
  }

  closeUserInfo.addEventListener('click', () => {
    userInfoModal.style.display = 'none';
  });

  // حذف رسالة عند الضغط المطول (اضغط مطولًا على الرسالة)
  function addDeleteHandler(messageDiv, messageKey, messageUid) {
    let timer = null;
    messageDiv.addEventListener('mousedown', () => {
      timer = setTimeout(() => {
        tryDeleteMessage(messageKey, messageUid);
      }, 1000); // ثانية واحدة ضغط مطول
    });
    messageDiv.addEventListener('mouseup', () => {
      clearTimeout(timer);
    });
    messageDiv.addEventListener('mouseleave', () => {
      clearTimeout(timer);
    });
  }

  // حذف رسالة (صاحب الرسالة أو المستخدم المميز فقط يمكنه الحذف)
  function tryDeleteMessage(messageKey, messageUid) {
    if(currentUser.uid === messageUid || currentUser.uid === specialUserId){
      if(confirm("هل تريد حذف هذه الرسالة؟")){
        db.ref('chatMessages/' + messageKey).remove();
      }
    } else {
      alert("لا يمكنك حذف هذه الرسالة");
    }
  }
</script>

</body>
</html>
