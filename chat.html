<!DOCTYPE html>  <html lang="ar" dir="rtl">  
<head>  
  <meta charset="UTF-8" />  
  <title>Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© - Sheko Store</title>  
  <meta name="viewport" content="width=device-width, initial-scale=1" />  
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700;900&display=swap" rel="stylesheet" />  
  <style>  
    body {  
      font-family: 'Cairo', sans-serif;  
      margin: 0;  
      padding: 0;  
      display: flex;  
      flex-direction: column;  
      height: 100vh;  
      background: linear-gradient(45deg, #fffbdb, #fff);  
    }  
    header {  
      background: #ffb700;  
      padding: 10px;  
      text-align: center;  
      font-weight: bold;  
      font-size: 1.5rem;  
      box-shadow: 0 2px 5px rgba(0,0,0,0.2);  
      position: relative;  
    }  
    #onlineCount {  
      position: absolute;  
      left: 15px;  
      top: 10px;  
      font-size: 0.9rem;  
      display: flex;  
      flex-direction: column;  
      align-items: center;  
    }  
    #onlineCount .eye {  
      font-size: 1.4rem;  
      user-select: none;  
    }  
    #chatContainer {  
      flex: 1;  
      padding: 10px;  
      overflow-y: auto;  
    }  
    .message {  
      display: flex;  
      margin-bottom: 12px;  
      align-items: flex-start;  
      position: relative;  
    }  
    .message.own {  
      flex-direction: row-reverse;  
    }  
    .avatar {  
      width: 48px;  
      height: 48px;  
      border-radius: 50%;  
      margin: 0 10px;  
      overflow: hidden;  
      cursor: pointer;  
      position: relative;  
    }  
    .avatar img {  
      width: 100%;  
      height: 100%;  
      object-fit: cover;  
    }  
    .content {  
      background: #ffb700;  
      color: #222;  
      padding: 10px 15px;  
      border-radius: 15px;  
      max-width: 70%;  
      position: relative;  
      word-break: break-word;  
    }  
    .message.own .content {  
      background: #222;  
      color: #ffb700;  
    }  
    .username {  
      font-weight: bold;  
      font-size: 0.9rem;  
      margin-bottom: 5px;  
    }  
    .timestamp {  
      font-size: 0.7rem;  
      color: #555;  
      margin-top: 4px;  
    }  
    .delete-btn {  
      background: #dc3545;  
      border: none;  
      color: #fff;  
      padding: 5px 10px;  
      border-radius: 10px;  
      cursor: pointer;  
      margin: auto 8px;  
      align-self: center;  
      font-size: 0.8rem;  
      transition: background-color 0.3s ease;  
    }  
    .delete-btn:hover {  
      background-color: #b02a37;  
    }  
    #inputContainer {  
      display: flex;  
      padding: 10px;  
      background: #eee;  
      border-top: 1px solid #ccc;  
      flex-direction: column;  
    }  
    #messageInput {  
      flex: 1;  
      padding: 10px;  
      border-radius: 20px;  
      border: 1px solid #ccc;  
      font-family: 'Cairo', sans-serif;  
      font-size: 1rem;  
      width: 100%;  
      box-sizing: border-box;  
    }  
    #sendBtn {  
      margin-top: 8px;  
      border: none;  
      padding: 10px 20px;  
      border-radius: 20px;  
      background: #ffb700;  
      font-weight: bold;  
      cursor: pointer;  
      font-size: 1rem;  
      transition: background-color 0.3s ease;  
      align-self: flex-end;  
    }  
    #sendBtn:hover {  
      background-color: #e6a600;  
    }  
    /* Ù†Ø§ÙØ°Ø© Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… */  
    #userInfoPopup {  
      position: fixed;  
      top: 20%;  
      left: 50%;  
      transform: translateX(-50%);  
      background: white;  
      padding: 20px 25px;  
      border-radius: 15px;  
      box-shadow: 0 8px 25px rgba(0,0,0,0.25);  
      max-width: 320px;  
      z-index: 1000;  
      display: none;  
      direction: rtl;  
      font-family: 'Cairo', sans-serif;  
      text-align: center;  
    }  
    #userInfoPopup .closeBtn {  
      position: absolute;  
      top: 8px;  
      left: 10px;  
      font-size: 1.2rem;  
      cursor: pointer;  
      font-weight: bold;  
      user-select: none;  
    }  
    #userInfoPopup img {  
      width: 100px;  
      height: 100px;  
      border-radius: 50%;  
      object-fit: cover;  
      margin-bottom: 10px;  
      box-shadow: 0 3px 10px rgba(0,0,0,0.2);  
    }  
    #userInfoPopup h3 {  
      margin: 5px 0;  
      font-weight: 900;  
      font-size: 1.3rem;  
      color: #ffb700;  
    }  
    #userInfoPopup .badges {  
      margin: 10px 0;  
      display: flex;  
      justify-content: center;  
      gap: 10px;  
      flex-wrap: wrap;  
    }  
    #userInfoPopup .badge {  
      background: #ffb700;  
      color: #222;  
      padding: 5px 10px;  
      border-radius: 12px;  
      font-weight: bold;  
      font-size: 0.85rem;  
      box-shadow: 0 1px 5px rgba(0,0,0,0.2);  
    }  
    #userInfoPopup .vip {  
      background: linear-gradient(45deg, gold, orange);  
      color: #111;  
      font-size: 1rem;  
      padding: 8px 15px;  
      border-radius: 20px;  
      box-shadow: 0 2px 8px rgba(255, 165, 0, 0.7);  
    }  /* Ø®Ù„ÙÙŠØ© Ø´ÙØ§ÙØ© Ø¹Ù†Ø¯ Ø¸Ù‡ÙˆØ± Ø§Ù„Ù†Ø§ÙØ°Ø© */  
#overlay {  
  position: fixed;  
  top: 0; left: 0; right: 0; bottom: 0;  
  background: rgba(0,0,0,0.3);  
  z-index: 900;  
  display: none;  
}  

/* ØµÙ†Ø¯ÙˆÙ‚ Ø§Ù„Ø±Ø¯ */  
#replyBox {  
  background: #ffb700;  
  padding: 8px 15px;  
  border-radius: 20px;  
  margin-bottom: 8px;  
  color: #222;  
  font-weight: bold;  
  cursor: pointer;  
  user-select: none;  
}

  </style>  
</head>  
<body>  
  <header>  
    <div id="onlineCount">  
      <div class="eye" title="Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙˆÙ† Ø§Ù„Ù…ØªØµÙ„ÙˆÙ†">ğŸ‘</div>  
      <div id="onlineNumber">0</div>  
    </div>  
    Ø¯Ø±Ø¯Ø´Ø© Sheko Store  
  </header>      <div id="chatContainer"></div>      <div id="inputContainer">  
    <!-- Ù…Ø±Ø¨Ø¹ Ø§Ù„Ø±Ø¯ ÙŠØ¸Ù‡Ø± Ù‡Ù†Ø§ Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠØ§Ù‹ -->  
    <input type="text" id="messageInput" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„ØªÙƒ Ù‡Ù†Ø§..." autocomplete="off" />  
    <button id="sendBtn">Ø¥Ø±Ø³Ø§Ù„</button>  
  </div>      <!-- Ù†Ø§ÙØ°Ø© Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… -->    <div id="overlay"></div>  
  <div id="userInfoPopup">  
    <div class="closeBtn" title="Ø¥ØºÙ„Ø§Ù‚">Ã—</div>  
    <img id="popupImage" src="" alt="ØµÙˆØ±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…" />  
    <h3 id="popupName">Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</h3>  
    <div class="badges" id="popupBadges"></div>  
    <div class="vip" id="popupVIP" style="display:none;"></div>  
    <div id="popupRank"></div>  
  </div>      <!-- Firebase Scripts -->    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-storage-compat.js"></script>    <script>  
    const firebaseConfig = {  
      apiKey: "AIzaSyAYcZ2_RjaI4fjP14QlqbUbL3rWvPPWnas",  
      authDomain: "sheko-store.firebaseapp.com",  
      databaseURL: "https://sheko-store-default-rtdb.firebaseio.com",  
      projectId: "sheko-store",  
      storageBucket: "sheko-store.appspot.com",  
      messagingSenderId: "113892775847",  
      appId: "1:113892775847:web:2aa4c11c3f5dd1d15f0882"  
    };  
    firebase.initializeApp(firebaseConfig);  
  
    const auth = firebase.auth();  
    const db = firebase.database();  
    const storage = firebase.storage();  
  
    const chatContainer = document.getElementById("chatContainer");  
    const messageInput = document.getElementById("messageInput");  
    const sendBtn = document.getElementById("sendBtn");  
    const onlineNumber = document.getElementById("onlineNumber");  
  
    const userInfoPopup = document.getElementById("userInfoPopup");  
    const overlay = document.getElementById("overlay");  
    const popupImage = document.getElementById("popupImage");  
    const popupName = document.getElementById("popupName");  
    const popupBadges = document.getElementById("popupBadges");  
    const popupVIP = document.getElementById("popupVIP");  
    const popupRank = document.getElementById("popupRank");  
    const closeBtn = userInfoPopup.querySelector(".closeBtn");  
  
    // Ø´Ø§Ø±Ø§Øª Ø®Ø§ØµØ© Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù… mlifDgEAkKMaOeuUq63cs5NAkV93  
    const specialBadgesForUser = {  
      "mlifDgEAkKMaOeuUq63cs5NAkV93": {  
        badges: ["Ø§Ù„Ù…Ø¤Ø³Ø³", "Ø§Ù„Ø£Ø³Ø·ÙˆØ±Ø©", "Ø§Ù„Ù…Ø¨Ø±Ù…Ø¬", "Ø§Ù„Ø§Ø¯Ù…Ù†"],  
        vip: 10  
      }  
    };  
  
    // Ø¥ÙŠÙ…ÙˆØ¬ÙŠ Ø§Ù„ØªÙØ§Ø¹Ù„  
    const reactionEmojis = ["â¤ï¸", "ğŸ˜‚", "ğŸ‘", "ğŸ‘"];  
  
    let currentUser;  
    let usersCache = {}; // ØªØ®Ø²ÙŠÙ† Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ù„ØªÙ‚Ù„ÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª  
  
    // Ù…ØªØºÙŠØ± Ù„ØªØ®Ø²ÙŠÙ† Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ø±Ø¯ (Ù…Ù‚ØªØ¨Ø³Ø©)  
    let replyMessage = null;  
  
    auth.onAuthStateChanged(user => {  
      let isUserBanned = false; // Ø­Ø§Ù„Ø© Ø§Ù„Ø­Ø¸Ø±

// Ø¨Ø¹Ø¯ Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø³Ø¬Ù‘Ù„ Ø§Ù„Ø¯Ø®ÙˆÙ„
db.ref("bannedUsers/" + user.uid).once("value").then(snap => {
  if (snap.exists()) {
    isUserBanned = true;
    messageInput.disabled = true;
    sendBtn.disabled = true;
    sendBtn.textContent = "ØªÙ… Ø­Ø¸Ø±Ùƒ Ù…Ù† Ø§Ù„Ø¯Ø±Ø¯Ø´Ø©";
  }
});
      if (!user) return location.href = "index.html";  
      currentUser = user;  
  
      // Ø³Ø¬Ù„ Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙÙŠ usersOnline  
      db.ref("usersOnline/" + user.uid).set(true);  
      db.ref("usersOnline/" + user.uid).onDisconnect().remove();  
  
      listenForMessages();  
    });  
  
    // ØªØ­Ø¯ÙŠØ« Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø§Ù„Ù…ØªØµÙ„ÙŠÙ†  
    db.ref("usersOnline").on("value", snap => {  
      const users = snap.val() || {};  
      onlineNumber.textContent = Object.keys(users).length;  
    });  
  
    // Ø­Ø§Ù„Ø© Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© (Ù…ÙØªÙˆØ­Ø©/Ù…ØºÙ„Ù‚Ø©)  
    let isChatOpen = true;  
    db.ref("chatSettings/isChatOpen").on("value", snap => {  
      isChatOpen = snap.val();  
      if (!isChatOpen) {  
        messageInput.disabled = true;  
        sendBtn.disabled = true;  
if (isUserBanned) return alert("ØªÙ… Ø­Ø¸Ø±Ùƒ Ù…Ù† Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„.");
        sendBtn.textContent = "Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© Ù…ØºÙ„Ù‚Ø© Ø­Ø§Ù„ÙŠØ§Ù‹";  
      } else {  
        messageInput.disabled = false;  
        sendBtn.disabled = false;  
        sendBtn.textContent = "Ø¥Ø±Ø³Ø§Ù„";  
      }  
    });  
  
    // Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø¹ Ø§Ù„Ø´Ø§Ø±Ø§Øª ÙˆØ§Ù„ÙÙŠ Ø£ÙŠ Ø¨ÙŠ  
    function getUserData(uid) {  
      return new Promise((resolve) => {  
        if (usersCache[uid]) {  
          resolve(usersCache[uid]);  
        } else {  
          db.ref("users/" + uid).once("value").then(userSnap => {  
            const data = userSnap.val() || {};  
            db.ref(`userBadges/${uid}/badges`).once("value").then(badgesSnap => {  
              const badges = badgesSnap.val() || [];  
              usersCache[uid] = {  
                ...data,  
                badges,  
                vip: specialBadgesForUser[uid]?.vip || data.vip || 0,  
              };  
              resolve(usersCache[uid]);  
            });  
          });  
        }  
      });  
    }  
  
    // Ø¹Ø±Ø¶ Ø±Ø³Ø§Ù„Ø© ÙˆØ§Ø­Ø¯Ø© Ù…Ø¹ Ø§Ù„ØªÙØ§Ø¹Ù„Ø§Øª ÙˆØ§Ù„Ø±Ø¯ÙˆØ¯  
    function renderMessage(id, msg) {  
      const msgDiv = document.createElement("div");  
      msgDiv.className = "message";  
      if (msg.uid === currentUser.uid) msgDiv.classList.add("own");  
  
      // Ø¹Ù†Ø¯ Ø§Ù„Ø¶ØºØ· Ù…Ø±ØªÙŠÙ† Ù„Ù„Ø±Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ø±Ø³Ø§Ù„Ø©  
      msgDiv.ondblclick = () => {  
        replyMessage = {  
          uid: msg.uid,  
          text: msg.text,  
          username: usersCache[msg.uid]?.username || "Ù…Ø³ØªØ®Ø¯Ù…"  
        };  
        showReplyUI(replyMessage);  
      };  
  
      // Ø§Ù„ØµÙˆØ±Ø©  
      const avatar = document.createElement("div");  
      avatar.className = "avatar";  
  
      getUserData(msg.uid).then(userData => {  
        avatar.innerHTML = `<img src="${userData.profileImage || 'https://via.placeholder.com/48?text=ØµÙˆØ±Ø©'}" alt="Ù…Ø³ØªØ®Ø¯Ù…" />`;  
        avatar.onclick = () => showUserInfo(userData);  
      });  
      msgDiv.appendChild(avatar);  
  
      // Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø±Ø³Ø§Ù„Ø©  
      const content = document.createElement("div");  
      content.className = "content";  
  
      // Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…  
      const usernameDiv = document.createElement("div");  
      usernameDiv.className = "username";  
      usernameDiv.textContent = usersCache[msg.uid]?.username || "Ù…Ø³ØªØ®Ø¯Ù…";  
      content.appendChild(usernameDiv);  
  
      // Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ø±Ø¯ Ø¥Ù† ÙˆØ¬Ø¯Øª  
      if (msg.replyTo) {  
        const replyDiv = document.createElement("div");  
        replyDiv.style = "border-left: 3px solid #ffb700; padding-left: 8px; margin-bottom: 5px; font-style: italic; color: #555;";  
        replyDiv.textContent = `Ø±Ø¯ Ø¹Ù„Ù‰ ${msg.replyTo.username}: ${msg.replyTo.text}`;  
        content.appendChild(replyDiv);  
      }  
  
      // Ù†Øµ Ø§Ù„Ø±Ø³Ø§Ù„Ø©  
      const textDiv = document.createElement("div");  
      textDiv.textContent = msg.text;  
      content.appendChild(textDiv);  
  
      // Ø·Ø§Ø¨Ø¹ Ø²Ù…Ù†ÙŠ  
      const timeDiv = document.createElement("div");  
      timeDiv.className = "timestamp";  
      timeDiv.textContent = new Date(msg.timestamp).toLocaleTimeString('ar-EG');  
      content.appendChild(timeDiv);  
  
      // Ø¥ÙŠÙ…ÙˆØ¬ÙŠ Ø§Ù„ØªÙØ§Ø¹Ù„Ø§Øª  
      const reactionsDiv = document.createElement("div");  
      reactionsDiv.style = "margin-top:5px; display:flex; gap:8px;";  
  
      // Ù‡Ù†Ø§ Ø§Ù„ØªÙØ§Ø¹Ù„ Ù…Ø®Ø²Ù† Ø¨Ø´ÙƒÙ„ ÙƒØ§Ø¦Ù† {emoji: {uid: true, uid2: true, ...}}  
      if (!msg.reactions) msg.reactions = {};  
  
      reactionEmojis.forEach(emoji => {  
        const btn = document.createElement("button");  
  
        // Ø­Ø³Ø§Ø¨ Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø§Ù„Ø°ÙŠÙ† ØªÙØ§Ø¹Ù„ÙˆØ§ Ø¨Ù‡Ø°Ø§ Ø§Ù„Ø¥ÙŠÙ…ÙˆØ¬ÙŠ  
        const usersReacted = msg.reactions[emoji] || {};  
        const count = Object.keys(usersReacted).length;  
  
        btn.textContent = emoji + (count > 0 ? " " + count : "");  
        btn.style = "background:none; border:none; cursor:pointer; font-size:1.2rem; user-select:none;";  
  
        btn.onclick = () => {  
          // ØªÙØ§Ø¹Ù„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø­Ø§Ù„ÙŠ Ù…Ø¹ Ø§Ù„Ø¥ÙŠÙ…ÙˆØ¬ÙŠ  
          const reactionsRef = db.ref("chatMessages/" + id + "/reactions/" + emoji);  
  
          if (usersReacted[currentUser.uid]) {  
            // Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù‚Ø¯ Ø£Ù„ØºÙ‰ Ø§Ù„ØªÙØ§Ø¹Ù„  
            reactionsRef.child(currentUser.uid).remove();  
          } else {  
            // Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙŠØ¶ÙŠÙ ØªÙØ§Ø¹Ù„  
            reactionsRef.child(currentUser.uid).set(true);  
          }  
        };  
  
        reactionsDiv.appendChild(btn);  
          
        });  
  
    content.appendChild(reactionsDiv);  
  
      msgDiv.appendChild(content);  
  
      // Ø²Ø± Ø§Ù„Ø­Ø°Ù (ÙŠØ¸Ù‡Ø± ÙÙ‚Ø· Ù„ØµØ§Ø­Ø¨ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø£Ùˆ Ø§Ù„Ø£Ø¯Ù…Ù†)  
      if (msg.uid === currentUser.uid || currentUser.uid === "mlifDgEAkKMaOeuUq63cs5NAkV93") {  
        const delBtn = document.createElement("button");  
        delBtn.className = "delete-btn";  
        delBtn.textContent = "Ø­Ø°Ù";  
        delBtn.onclick = () => {  
          if (confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„Ø±Ø³Ø§Ù„Ø©ØŸ")) {  
            db.ref("chatMessages/" + id).remove();  
          }  
        };  
        msgDiv.appendChild(delBtn);  
      }  
  
      return msgDiv;  
    }  
  
    // Ø¹Ø±Ø¶ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙÙŠ Ø§Ù„Ù†Ø§ÙØ°Ø© Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚Ø©  
    function showUserInfo(userData) {  
      popupImage.src = userData.profileImage || 'https://via.placeholder.com/100?text=ØµÙˆØ±Ø©';  
      popupName.textContent = userData.username || "Ù…Ø³ØªØ®Ø¯Ù…";  
      popupBadges.innerHTML = "";  
      if (userData.badges && userData.badges.length > 0) {  
        userData.badges.forEach(b => {  
          const badgeSpan = document.createElement("span");  
          badgeSpan.className = "badge";  
          badgeSpan.textContent = b;  
          popupBadges.appendChild(badgeSpan);  
        });  
      }  
      if (userData.vip && userData.vip > 0) {  
        popupVIP.style.display = "block";  
        popupVIP.textContent = `VIP ${userData.vip}`;  
      } else {  
        popupVIP.style.display = "none";  
      }  
      userInfoPopup.style.display = "block";  
      overlay.style.display = "block";  
    }  
    closeBtn.onclick = () => {  
      userInfoPopup.style.display = "none";  
      overlay.style.display = "none";  
    };  
    overlay.onclick = () => {  
      userInfoPopup.style.display = "none";  
      overlay.style.display = "none";  
      hideReplyUI();  
    };  
  
    // Ø¥Ø¸Ù‡Ø§Ø± ØµÙ†Ø¯ÙˆÙ‚ Ø§Ù„Ø±Ø¯  
    function showReplyUI(replyMsg) {  
      if (document.getElementById("replyBox")) return; // Ù…ÙˆØ¬ÙˆØ¯ Ù…Ø³Ø¨Ù‚Ø§Ù‹  
      const replyBox = document.createElement("div");  
      replyBox.id = "replyBox";  
      replyBox.textContent = `Ø±Ø¯ Ø¹Ù„Ù‰ ${replyMsg.username}: ${replyMsg.text}`;  
      replyBox.onclick = () => {  
        replyMessage = null;  
        hideReplyUI();  
      };  
      const inputContainer = document.getElementById("inputContainer");  
      inputContainer.insertBefore(replyBox, messageInput);  
    }  
  
    // Ø¥Ø®ÙØ§Ø¡ ØµÙ†Ø¯ÙˆÙ‚ Ø§Ù„Ø±Ø¯  
    function hideReplyUI() {  
      const replyBox = document.getElementById("replyBox");  
      if (replyBox) replyBox.remove();  
      replyMessage = null;  
    }  
  
    // Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø©  
    sendBtn.onclick = () => {  
      const text = messageInput.value.trim();  
      if (text === "") return;  
      if (!isChatOpen) return alert("Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© Ù…ØºÙ„Ù‚Ø© Ø­Ø§Ù„ÙŠØ§Ù‹.");  
  
      const newMsgRef = db.ref("chatMessages").push();  
      const msgData = {  
        uid: currentUser.uid,  
        text,  
        timestamp: Date.now()  
      };  
      if (replyMessage) {  
        msgData.replyTo = {  
          uid: replyMessage.uid,  
          text: replyMessage.text,  
          username: replyMessage.username  
        };  
      }  
  
      newMsgRef.set(msgData).then(() => {  
        messageInput.value = "";  
        hideReplyUI();  
      });  
    };  
  
    // Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹ Ù„ØªØ­Ø¯ÙŠØ«Ø§Øª Ø§Ù„Ø±Ø³Ø§Ø¦Ù„  
    function listenForMessages() {  
      db.ref("chatMessages").on("value", snapshot => {  
        const messages = snapshot.val() || {};  
        chatContainer.innerHTML = "";  
  
        // ØªØ±ØªÙŠØ¨ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø­Ø³Ø¨ Ø§Ù„ÙˆÙ‚Øª  
        const sortedMessages = Object.entries(messages).sort((a, b) => a[1].timestamp - b[1].timestamp);  
  
        sortedMessages.forEach(([id, msg]) => {  
          // Ù„ØªØ­Ø¯ÙŠØ« Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ù‚Ø¨Ù„ Ø¹Ø±Ø¶ Ø§Ù„Ø±Ø³Ø§Ù„Ø©  
          getUserData(msg.uid).then(() => {  
            const msgElem = renderMessage(id, msg);  
            chatContainer.appendChild(msgElem);  
            chatContainer.scrollTop = chatContainer.scrollHeight;  
          });  
        });  
      });  
    }  
  </script>  </body>  
</html>  
