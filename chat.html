<!DOCTYPE html><html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>دردشة جماعية - Sheko Store</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet">
  <style>
    body {
      margin: 0;
      font-family: 'Cairo', sans-serif;
      background: #f1f1f1;
    }
    .chat-container {
      max-width: 600px;
      margin: auto;
      display: flex;
      flex-direction: column;
      height: 100vh;
      background: #fff;
      border: 1px solid #ccc;
      box-shadow: 0 0 10px #ccc;
    }
    .messages {
      flex: 1;
      padding: 10px;
      overflow-y: auto;
    }
    .message {
      background: #e9e9e9;
      padding: 8px 12px;
      margin-bottom: 8px;
      border-radius: 12px;
      position: relative;
      animation: fadeInUp 0.3s ease-in-out;
    }
    .message.own {
      background: #dcf8c6;
      align-self: flex-end;
    }
    .message img {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      vertical-align: middle;
      cursor: pointer;
    }
    .message .username {
      font-size: 13px;
      font-weight: bold;
      color: #555;
      margin-bottom: 4px;
    }
    .message .text {
      font-size: 15px;
    }
    .input-area {
      display: flex;
      border-top: 1px solid #ccc;
    }
    input {
      flex: 1;
      padding: 10px;
      border: none;
      font-size: 16px;
    }
    button {
      padding: 10px 20px;
      border: none;
      background: #25d366;
      color: white;
      font-weight: bold;
      cursor: pointer;
    }
    .user-popup {
      position: absolute;
      background: #fff;
      border: 1px solid #ccc;
      box-shadow: 0 2px 5px rgba(0,0,0,0.2);
      padding: 10px;
      display: none;
      z-index: 100;
    }
    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
  </style>
</head>
<body>
  <div class="chat-container">
    <div class="messages" id="messages"></div>
    <div class="input-area">
      <input id="messageInput" placeholder="اكتب رسالة...">
      <button onclick="sendMessage()">إرسال</button>
    </div>
  </div>  <!-- نافذة معلومات المستخدم -->  <div id="userPopup" class="user-popup"></div>  <!-- Firebase -->  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyAYcZ2_RjaI4fjP14QlqbUbL3rWvPPWnas",
      authDomain: "sheko-store.firebaseapp.com",
      databaseURL: "https://sheko-store-default-rtdb.firebaseio.com",
      projectId: "sheko-store",
      storageBucket: "sheko-store.appspot.com",
      messagingSenderId: "113892775847",
      appId: "1:113892775847:web:2aa4c11c3f5dd1d15f0882"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.database();

    const messagesDiv = document.getElementById("messages");
    const messageInput = document.getElementById("messageInput");
    const userPopup = document.getElementById("userPopup");

    const BAD_WORDS = ["كلمةسيئة", "شتيمة"];
    const adminUID = "mlifDgEAkKMaOeuUq63cs5NAkV93";

    let currentUser = null;

    auth.onAuthStateChanged(user => {
      if (!user) return location.href = "index.html";
      currentUser = user;
      loadMessages();
    });

    function cleanText(text) {
      BAD_WORDS.forEach(w => {
        const regex = new RegExp(w, 'gi');
        text = text.replace(regex, "***");
      });
      return text;
    }

    function sendMessage() {
      const text = cleanText(messageInput.value.trim());
      if (!text) return;
      db.ref("groupMessages").push({
        uid: currentUser.uid,
        email: currentUser.email,
        photo: currentUser.photoURL || "",
        name: currentUser.displayName || "مستخدم",
        text: text,
        timestamp: Date.now()
      });
      messageInput.value = "";
    }

    function loadMessages() {
      db.ref("groupMessages").on("child_added", snapshot => {
        const msg = snapshot.val();
        const key = snapshot.key;
        const div = document.createElement("div");
        div.className = "message";
        if (msg.uid === currentUser.uid) div.classList.add("own");

        div.innerHTML = `
          <img src="${msg.photo}" alt="" onclick="showUserInfo('${msg.uid}', this)">
          <div class="username">${msg.name}</div>
          <div class="text">${msg.text}</div>
        `;

        div.addEventListener("contextmenu", (e) => {
          e.preventDefault();
          if (msg.uid === currentUser.uid || currentUser.uid === adminUID) {
            if (confirm("هل تريد حذف هذه الرسالة؟")) {
              db.ref(`groupMessages/${key}`).remove();
            }
          }
        });

        messagesDiv.appendChild(div);
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
      });
    }

    function showUserInfo(uid, el) {
      db.ref(`users/${uid}`).once("value").then(snap => {
        const data = snap.val();
        let html = `<img src="${data.photo || ''}" width="60"><br>`;
        html += `<strong>${data.name || 'مستخدم'}</strong><br>`;
        html += `الرتبة: ${data.rank || 'غير محدد'}<br>`;
        if (data.partnerBadge) html += `<span style='color:#ffb700'>🔰 شارة الشراكة</span>`;
        userPopup.innerHTML = html;
        userPopup.style.display = "block";
        userPopup.style.left = el.getBoundingClientRect().left + "px";
        userPopup.style.top = (el.getBoundingClientRect().top + 40) + "px";

        setTimeout(() => userPopup.style.display = "none", 4000);
      });
    }
  </script></body>
</html>
