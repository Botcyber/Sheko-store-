Ø§Ø±ÙŠØ¯ Ø§Ø¶Ø§Ù‚Ù‡ Ø§Ù†Ù…ÙŠØ´Ù† Ù„Ù„ØµÙØ­Ù‡ ÙˆØªØ£Ø«ÙŠØ±Ø§Øª
ÙˆØªØ£Ø«ÙŠØ±Ø§Øª Ø§Ù„ØªÙØ§Ø¹Ù„ ÙˆØ§Ù†Ù…ÙŠØ´Ù† Ø§Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ù‡
ÙˆØ§Ø±ÙŠØ¯ Ø´ÙƒÙ„ Ø§Ù„ØµÙØ­Ù‡ Ø¬Ø°Ø§Ø¨ ÙˆØ­Ø¯ÙŠØ« ÙˆØ§Ù†ÙŠÙ‚ ÙˆØ¬Ù…ÙŠÙ„

Ø¯ÙˆÙ† ØªØºÙŠØ± Ø§ÙŠ Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø·Ù„Ù‚Ø§

<!DOCTYPE html>  <html lang="ar" dir="rtl">  
<head>  
  <meta charset="UTF-8" />  
  <title>Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© - Sheko Store</title>  
  <meta name="viewport" content="width=device-width, initial-scale=1" />  
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700;900&display=swap" rel="stylesheet" />  
  <style>  
    body {  
      font-family: 'Cairo', sans-serif;  
      margin: 0;  
      padding: 0;  
      display: flex;  
      flex-direction: column;  
      height: 100vh;  
      background: linear-gradient(45deg, #fffbdb, #fff);  
    }  
    header {  
      background: #ffb700;  
      padding: 10px;  
      text-align: center;  
      font-weight: bold;  
      font-size: 1.5rem;  
      box-shadow: 0 2px 5px rgba(0,0,0,0.2);  
      position: relative;  
    }  
    #onlineCount {  
      position: absolute;  
      left: 15px;  
      top: 10px;  
      font-size: 0.9rem;  
      display: flex;  
      flex-direction: column;  
      align-items: center;  
    }  
    #onlineCount .eye {  
      font-size: 1.4rem;  
      user-select: none;  
    }  
    #chatContainer {  
      flex: 1;  
      padding: 10px;  
      overflow-y: auto;  
    }  
    .message {  
      display: flex;  
      margin-bottom: 12px;  
      align-items: flex-start;  
      position: relative;  
    }  
    .message.own {  
      flex-direction: row-reverse;  
    }  
    .avatar {  
      width: 48px;  
      height: 48px;  
      border-radius: 50%;  
      margin: 0 10px;  
      overflow: hidden;  
      cursor: pointer;  
      position: relative;  
    }  
    .avatar img {  
      width: 100%;  
      height: 100%;  
      object-fit: cover;  
    }  
    .content {  
      background: #ffb700;  
      color: #222;  
      padding: 10px 15px;  
      border-radius: 15px;  
      max-width: 70%;  
      position: relative;  
      word-break: break-word;  
    }  
    .message.own .content {  
      background: #222;  
      color: #ffb700;  
    }  
    .username {  
      font-weight: bold;  
      font-size: 0.9rem;  
      margin-bottom: 5px;  
    }  
    .timestamp {  
      font-size: 0.7rem;  
      color: #555;  
      margin-top: 4px;  
    }  
    .delete-btn {  
      background: #dc3545;  
      border: none;  
      color: #fff;  
      padding: 5px 10px;  
      border-radius: 10px;  
      cursor: pointer;  
      margin: auto 8px;  
      align-self: center;  
      font-size: 0.8rem;  
      transition: background-color 0.3s ease;  
    }  
    .delete-btn:hover {  
      background-color: #b02a37;  
    }  
    #inputContainer {  
      display: flex;  
      padding: 10px;  
      background: #eee;  
      border-top: 1px solid #ccc;  
      flex-direction: column;  
    }  
    #messageInput {  
      flex: 1;  
      padding: 10px;  
      border-radius: 20px;  
      border: 1px solid #ccc;  
      font-family: 'Cairo', sans-serif;  
      font-size: 1rem;  
      width: 100%;  
      box-sizing: border-box;  
    }  
    #sendBtn {  
      margin-top: 8px;  
      border: none;  
      padding: 10px 20px;  
      border-radius: 20px;  
      background: #ffb700;  
      font-weight: bold;  
      cursor: pointer;  
      font-size: 1rem;  
      transition: background-color 0.3s ease;  
      align-self: flex-end;  
    }  
    #sendBtn:hover {  
      background-color: #e6a600;  
    }  /* Ù†Ø§ÙØ°Ø© Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… */  
#userInfoPopup {  
  position: fixed;  
  top: 20%;  
  left: 50%;  
  transform: translateX(-50%);  
  background: white;  
  padding: 20px 25px;  
  border-radius: 15px;  
  box-shadow: 0 8px 25px rgba(0,0,0,0.25);  
  max-width: 320px;  
  z-index: 1000;  
  display: none;  
  direction: rtl;  
  font-family: 'Cairo', sans-serif;  
  text-align: center;  
}  
#userInfoPopup .closeBtn {  
  position: absolute;  
  top: 8px;  
  left: 10px;  
  font-size: 1.2rem;  
  cursor: pointer;  
  font-weight: bold;  
  user-select: none;  
}  
#userInfoPopup img {  
  width: 100px;  
  height: 100px;  
  border-radius: 50%;  
  object-fit: cover;  
  margin-bottom: 10px;  
  box-shadow: 0 3px 10px rgba(0,0,0,0.2);  
}  
#userInfoPopup h3 {  
  margin: 5px 0;  
  font-weight: 900;  
  font-size: 1.3rem;  
  color: #ffb700;  
}  
#userInfoPopup .badges {  
  margin: 10px 0;  
  display: flex;  
  justify-content: center;  
  gap: 10px;  
  flex-wrap: wrap;  
}  
#userInfoPopup .badge {  
  background: #ffb700;  
  color: #222;  
  padding: 5px 10px;  
  border-radius: 12px;  
  font-weight: bold;  
  font-size: 0.85rem;  
  box-shadow: 0 1px 5px rgba(0,0,0,0.2);  
}  
#userInfoPopup .vip {  
  background: linear-gradient(45deg, gold, orange);  
  color: #111;  
  font-size: 1rem;  
  padding: 8px 15px;  
  border-radius: 20px;  
  box-shadow: 0 2px 8px rgba(255, 165, 0, 0.7);  
}  

/* Ø®Ù„ÙÙŠØ© Ø´ÙØ§ÙØ© Ø¹Ù†Ø¯ Ø¸Ù‡ÙˆØ± Ø§Ù„Ù†Ø§ÙØ°Ø© */  
#overlay {  
  position: fixed;  
  top: 0; left: 0; right: 0; bottom: 0;  
  background: rgba(0,0,0,0.3);  
  z-index: 900;  
  display: none;  
}

  </style>  
</head>  
<body>  
  <header>  
    <div id="onlineCount">  
      <div class="eye" title="Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙˆÙ† Ø§Ù„Ù…ØªØµÙ„ÙˆÙ†">ğŸ‘</div>  
      <div id="onlineNumber">0</div>  
    </div>  
    Ø¯Ø±Ø¯Ø´Ø© Sheko Store  
  </header>    <div id="chatContainer"></div>    <div id="inputContainer">  
    <!-- Ù…Ø±Ø¨Ø¹ Ø§Ù„Ø±Ø¯ ÙŠØ¸Ù‡Ø± Ù‡Ù†Ø§ Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠØ§Ù‹ -->  
    <input type="text" id="messageInput" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„ØªÙƒ Ù‡Ù†Ø§..." autocomplete="off" />  
    <button id="sendBtn">Ø¥Ø±Ø³Ø§Ù„</button>  
  </div>    <!-- Ù†Ø§ÙØ°Ø© Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… -->    <div id="overlay"></div>  
  <div id="userInfoPopup">  
    <div class="closeBtn" title="Ø¥ØºÙ„Ø§Ù‚">Ã—</div>  
    <img id="popupImage" src="" alt="ØµÙˆØ±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…" />  
    <h3 id="popupName">Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</h3>  
    <div class="badges" id="popupBadges"></div>  
    <div class="vip" id="popupVIP" style="display:none;"></div>  
    <div id="popupRank"></div>  
  </div>    <!-- Firebase Scripts -->    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-storage-compat.js"></script>    <script>  
    const firebaseConfig = {  
      apiKey: "AIzaSyAYcZ2_RjaI4fjP14QlqbUbL3rWvPPWnas",  
      authDomain: "sheko-store.firebaseapp.com",  
      databaseURL: "https://sheko-store-default-rtdb.firebaseio.com",  
      projectId: "sheko-store",  
      storageBucket: "sheko-store.appspot.com",  
      messagingSenderId: "113892775847",  
      appId: "1:113892775847:web:2aa4c11c3f5dd1d15f0882"  
    };  
    firebase.initializeApp(firebaseConfig);  
  
    const auth = firebase.auth();  
    const db = firebase.database();  
    const storage = firebase.storage();  
  
    const chatContainer = document.getElementById("chatContainer");  
    const messageInput = document.getElementById("messageInput");  
    const sendBtn = document.getElementById("sendBtn");  
    const onlineNumber = document.getElementById("onlineNumber");  
  
    const userInfoPopup = document.getElementById("userInfoPopup");  
    const overlay = document.getElementById("overlay");  
    const popupImage = document.getElementById("popupImage");  
    const popupName = document.getElementById("popupName");  
    const popupBadges = document.getElementById("popupBadges");  
    const popupVIP = document.getElementById("popupVIP");  
    const popupRank = document.getElementById("popupRank");  
    const closeBtn = userInfoPopup.querySelector(".closeBtn");  
  
    // Ø´Ø§Ø±Ø§Øª Ø®Ø§ØµØ© Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù… mlifDgEAkKMaOeuUq63cs5NAkV93  
    const specialBadgesForUser = {  
      "mlifDgEAkKMaOeuUq63cs5NAkV93": {  
        badges: ["Ø§Ù„Ù…Ø¤Ø³Ø³", "Ø§Ù„Ø£Ø³Ø·ÙˆØ±Ø©", "Ø§Ù„Ù…Ø¨Ø±Ù…Ø¬", "Ø§Ù„Ø§Ø¯Ù…Ù†"],  
        vip: 10  
      }  
    };  
  
    let currentUser;  
    let usersCache = {}; // Ù„ØªØ®Ø²ÙŠÙ† Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ù„ØªÙ‚Ù„ÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª  
  
    // Ù…ØªØºÙŠØ± Ù„ØªØ®Ø²ÙŠÙ† Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ø±Ø¯ (Ù…Ù‚ØªØ¨Ø³Ø©)  
    let replyMessage = null;  
  
    auth.onAuthStateChanged(user => {  
      if (!user) return location.href = "index.html";  
      currentUser = user;  
  
      // Ø³Ø¬Ù„ Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙÙŠ usersOnline  
      db.ref("usersOnline/" + user.uid).set(true);  
      db.ref("usersOnline/" + user.uid).onDisconnect().remove();  
  
      listenForMessages();  
    });  
  
    // ØªØ­Ø¯ÙŠØ« Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø§Ù„Ù…ØªØµÙ„ÙŠÙ†  
    db.ref("usersOnline").on("value", snap => {  
      const users = snap.val() || {};  
      onlineNumber.textContent = Object.keys(users).length;  
    });  
  
    // Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹ Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ø¯Ø±Ø¯Ø´Ø©  
    function listenForMessages() {  
      db.ref("chatMessages").on("value", snap => {  
        const msgs = snap.val() || {};  
        chatContainer.innerHTML = "";  
        Object.entries(msgs).forEach(([id, msg]) => renderMessage(id, msg, id));  
        chatContainer.scrollTop = chatContainer.scrollHeight;  
      });  
    }  
  
    // Ø§Ù„Ø¥ÙŠÙ…ÙˆØ¬ÙŠ Ù„Ù„ØªÙØ§Ø¹Ù„  
    const reactionEmojis = ["â¤ï¸", "ğŸ˜‚", "ğŸ‘", "ğŸ‘"];  
  
    // Ø¹Ø±Ø¶ Ø±Ø³Ø§Ù„Ø© ÙˆØ§Ø­Ø¯Ø©  
    function renderMessage(id, msg) {  
      const msgDiv = document.createElement("div");  
      msgDiv.className = "message";  
      if (msg.uid === currentUser.uid) msgDiv.classList.add("own");  
  
      // Ø¹Ù†ØµØ± Ø§Ù„ØµÙˆØ±Ø© (Ø§Ù„Ø£ÙØ§ØªØ§Ø±)  
      const avatar = document.createElement("div");  
      avatar.className = "avatar";  
  
      // Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ù† Ø§Ù„ÙƒØ§Ø´ Ø£Ùˆ Ù…Ù† Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª  
      getUserData(msg.uid).then(userData => {  
        avatar.innerHTML = '';  
        const img = document.createElement("img");  
        img.src = userData.profileImage || "https://via.placeholder.com/48?text=ØµÙˆØ±Ø©";  
        img.alt = userData.username || "Ù…Ø³ØªØ®Ø¯Ù…";  
  
        avatar.appendChild(img);  
  
        // Ø¹Ù†Ø¯ Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Ø§Ù„ØµÙˆØ±Ø© ØªØ¸Ù‡Ø± Ù†Ø§ÙØ°Ø© Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…  
        avatar.onclick = () => showUserInfo(userData);  
      });  
  
      // Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ù…Ø¹ Ø§Ù„Ø±Ø¯ Ø§Ù„Ù…Ù‚ØªØ¨Ø³ (Ø¥Ù† ÙˆØ¬Ø¯)  
      const content = document.createElement("div");  
      content.className = "content";  
  
      // Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ Ø¨Ø¯Ù„ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ  
      const displayName = msg.username && msg.username !== msg.uid ? msg.username : (msg.username || "Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø¬Ù‡ÙˆÙ„");  
  
      let replyHTML = "";  
      if (msg.replyTo && typeof msg.replyTo === "object" && msg.replyTo.text) {  
        replyHTML = `  
          <div style="background:#f0e68c; padding:6px 10px; border-radius:10px; margin-bottom:6px; font-size:0.8rem; color:#444;">  
            <strong>Ø±Ø¯ Ø¹Ù„Ù‰:</strong> ${escapeHtml(msg.replyTo.text.slice(0, 50))}${msg.replyTo.text.length > 50 ? "..." : ""}  
          </div>  
        `;  
      }  
  
      // Ø§Ù„ØªÙØ§Ø¹Ù„ - Ø¹Ø±Ø¶ Ø§Ù„Ø¥ÙŠÙ…ÙˆØ¬ÙŠ ÙˆØ¹Ø¯Ø¯Ù‡Ù…  
      let reactionsHTML = "";  
      if (msg.reactions) {  
        reactionsHTML = `<div style="margin-top: 6px;">`;  
        for (const [emoji, users] of Object.entries(msg.reactions)) {  
          reactionsHTML += `<span style="cursor:pointer; margin-right: 8px;" title="${emoji}">${emoji} (${Object.keys(users).length})</span>`;  
        }  
        reactionsHTML += `</div>`;  
      }  
  
      content.innerHTML = `  
        <div class="username">${escapeHtml(displayName)}</div>  
        ${replyHTML}  
        <div>${escapeHtml(msg.text)}</div>  
        <div class="timestamp">${new Date(msg.timestamp).toLocaleString("ar-EG")}</div>  
        ${reactionsHTML}  
      `;  
  
      // Ø²Ø± Ø­Ø°Ù Ø§Ù„Ø±Ø³Ø§Ù„Ø©:  
      // - ÙŠØ³Ù…Ø­ Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù… ØµØ§Ø­Ø¨ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø¨Ø­Ø°ÙÙ‡Ø§  
      // - ÙˆÙŠØ³Ù…Ø­ Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø®Ø§Øµ Ø¨Ø­Ø°Ù Ø£ÙŠ Ø±Ø³Ø§Ù„Ø©  
      if (msg.uid === currentUser.uid || currentUser.uid === "mlifDgEAkKMaOeuUq63cs5NAkV93") {  
        const del = document.createElement("button");  
        del.textContent = "Ø­Ø°Ù";  
        del.className = "delete-btn";  
        del.onclick = () => {  
          if (confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„Ø±Ø³Ø§Ù„Ø©ØŸ")) {  
            db.ref("chatMessages/" + id).remove();  
          }  
        };  
        msgDiv.appendChild(del);  
      }  
  
      // Ø¥Ø¶Ø§ÙØ© Ø®Ø§ØµÙŠØ© Ø§Ù„ØªÙØ§Ø¹Ù„ Ø¨Ø§Ù„Ø¥ÙŠÙ…ÙˆØ¬ÙŠ  
      const reactionsContainer = document.createElement("div");  
      reactionsContainer.style.marginTop = "5px";  
      reactionEmojis.forEach(emoji => {  
        const emojiBtn = document.createElement("span");  
        emojiBtn.textContent = emoji;  
        emojiBtn.style.cursor = "pointer";  
        emojiBtn.style.marginRight = "8px";  
        emojiBtn.title = "Ø§Ø¶ØºØ· Ù„Ù„ØªÙØ§Ø¹Ù„ Ø¨Ù€ " + emoji;  
        emojiBtn.onclick = () => toggleReaction(id, emoji);  
        reactionsContainer.appendChild(emojiBtn);  
      });  
      content.appendChild(reactionsContainer);  
  
      // Ø¥Ø¶Ø§ÙØ© Ø§Ø³ØªÙ…Ø§Ø¹ Ù„Ø³Ø­Ø¨ Ø§Ù„Ø±Ø³Ø§Ù„Ø© ÙŠÙ…ÙŠÙ† Ù„Ù„Ø±Ø¯ (Swipe Right)  
      addSwipeRightListener(msgDiv, msg, id);  
  
      msgDiv.appendChild(avatar);  
      msgDiv.appendChild(content);  
      chatContainer.appendChild(msgDiv);  
    }  
  
    // Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø©  
    sendBtn.onclick = () => {  
      const text = messageInput.value.trim();  
      if (!text) return alert("Ø§Ù„Ø±Ø¬Ø§Ø¡ ÙƒØªØ§Ø¨Ø© Ø±Ø³Ø§Ù„Ø©");  
  
      // Ø¥Ø­Ø¶Ø§Ø± Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ Ù‚Ø¨Ù„ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ù…Ù† Ø§Ù„ÙƒØ§Ø´ Ø£Ùˆ Ù…Ù† currentUser.displayName  
      getUserData(currentUser.uid).then(userData => {  
        const msg = {  
          uid: currentUser.uid,  
          username: userData.username || currentUser.email,  
          text,  
          timestamp: Date.now(),  
          photoURL: currentUser.photoURL || null,  
        };  
  
        // Ø¥Ø°Ø§ ÙƒØ§Ù† Ù‡Ù†Ø§Ùƒ Ø±Ø³Ø§Ù„Ø© Ù„Ù„Ø±Ø¯ Ø¹Ù„ÙŠÙ‡Ø§ØŒ Ù†Ø¶ÙŠÙÙ‡Ø§  
        if (replyMessage) {  
          msg.replyTo = {  
            text: replyMessage.text,  
            uid: replyMessage.uid,  
            username: replyMessage.username  
          };  
          replyMessage = null;  
          clearReplyUI();  
        }  
  
        db.ref("chatMessages").push(msg);  
        messageInput.value = "";  
      });  
    };  
  
    // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… (Ø§Ø³Ù…ØŒ ØµÙˆØ±Ø©ØŒ Ø´Ø§Ø±Ø§ØªØŒ Ø±ØªØ¨...)  
    function getUserData(uid) {  
      return new Promise((resolve) => {  
        if (usersCache[uid]) return resolve(usersCache[uid]);  
  
        db.ref("users/" + uid).once("value").then(snap => {  
          let data = snap.val() || {};  
  
          // Ø¥Ø°Ø§ Ù‡Ùˆ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ù…Ù…ÙŠØ²ØŒ Ù†Ø¶ÙŠÙ Ø§Ù„Ø´Ø§Ø±Ø§Øª Ø§Ù„Ø®Ø§ØµØ© ÙˆVIP  
          if (specialBadgesForUser[uid]) {  
            data.badges = specialBadgesForUser[uid].badges;  
            data.vip = specialBadgesForUser[uid].vip;  
          }  
  
          usersCache[uid] = {  
            username: data.username || "Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø¬Ù‡ÙˆÙ„",  
            profileImage: data.profileImage || "https://via.placeholder.com/48?text=ØµÙˆØ±Ø©",  
            badges: data.badges || [],  
            vip: data.vip || null,  
            rank: data.rank || null  
          };  
          resolve(usersCache[uid]);  
        });  
      });  
    }  
  
    // Ø¹Ø±Ø¶ Ù†Ø§ÙØ°Ø© Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…  
    function showUserInfo(userData) {  
      popupImage.src = userData.profileImage;  
      popupName.textContent = userData.username;  
  
      // Ø¹Ø±Ø¶ Ø§Ù„Ø´Ø§Ø±Ø§Øª  
      popupBadges.innerHTML = "";  
      if (userData.badges && userData.badges.length) {  
        userData.badges.forEach(badge => {  
          const span = document.createElement("span");  
          span.className = "badge";  
          span.textContent = badge;  
          popupBadges.appendChild(span);  
        });  
} else {  
        popupBadges.textContent = "Ù„Ø§ ØªÙˆØ¬Ø¯ Ø´Ø§Ø±Ø§Øª";  
      }  
  
      // Ø¹Ø±Ø¶ VIP Ø¥Ø°Ø§ Ù…ÙˆØ¬ÙˆØ¯  
      if (userData.vip) {  
        popupVIP.style.display = "inline-block";  
        popupVIP.textContent = "VIP Ø±ØªØ¨Ø© " + userData.vip;  
      } else {  
        popupVIP.style.display = "none";  
        popupVIP.textContent = "";  
      }  
  
      // Ø¹Ø±Ø¶ Ø§Ù„Ø±ØªØ¨Ø©  
      if (userData.rank) {  
        popupRank.textContent = "Ø§Ù„ØªØµÙ†ÙŠÙ: " + userData.rank;  
      } else {  
        popupRank.textContent = "";  
      }  
  
      overlay.style.display = "block";  
      userInfoPopup.style.display = "block";  
  
      clearTimeout(userInfoPopup.timeoutId);  
      userInfoPopup.timeoutId = setTimeout(() => {  
        closeUserInfo();  
      }, 4000);  
    }  
  
    // Ø¥ØºÙ„Ø§Ù‚ Ù†Ø§ÙØ°Ø© Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª  
    function closeUserInfo() {  
      overlay.style.display = "none";  
      userInfoPopup.style.display = "none";  
    }  
  
    closeBtn.onclick = closeUserInfo;  
    overlay.onclick = closeUserInfo;  
  
    // Ø¯Ø§Ù„Ø© ØªØ¹Ù‚ÙŠÙ… Ø§Ù„Ù†Øµ (Ù„Ù…Ù†Ø¹ XSS)  
    function escapeHtml(text) {  
      const div = document.createElement("div");  
      div.textContent = text;  
      return div.innerHTML;  
    }  
  
    // ØªÙØ¹ÙŠÙ„/ØªØ¹Ø·ÙŠÙ„ Ø§Ù„ØªÙØ§Ø¹Ù„ Ø¨Ø§Ù„Ø¥ÙŠÙ…ÙˆØ¬ÙŠ  
    function toggleReaction(messageId, emoji) {  
      const reactionsRef = db.ref(`chatMessages/${messageId}/reactions/${emoji}/${currentUser.uid}`);  
      reactionsRef.once("value").then(snapshot => {  
        if (snapshot.exists()) {  
          // Ø¥Ù„ØºØ§Ø¡ Ø§Ù„ØªÙØ§Ø¹Ù„  
          reactionsRef.remove();  
        } else {  
          // Ø¥Ø¶Ø§ÙØ© Ø§Ù„ØªÙØ§Ø¹Ù„  
          reactionsRef.set(true);  
        }  
      });  
    }  
  
    // Ø§Ø³ØªÙ…Ø§Ø¹ Ù„Ø³Ø­Ø¨ Ø§Ù„Ø±Ø³Ø§Ù„Ø© ÙŠÙ…ÙŠÙ† (Swipe Right) Ù„Ù„Ø±Ø¯ Ø¹Ù„ÙŠÙ‡Ø§  
    function addSwipeRightListener(msgDiv, msg, msgId) {  
      let startX = 0;  
      let dist = 0;  
      const threshold = 50; // Ø¹Ø¯Ø¯ Ø§Ù„Ø¨ÙŠÙƒØ³Ù„Ø§Øª Ù„Ù„Ø³Ø­Ø¨  
  
      msgDiv.addEventListener("touchstart", e => {  
        startX = e.touches[0].clientX;  
      }, {passive:true});  
  
      msgDiv.addEventListener("touchmove", e => {  
        dist = e.touches[0].clientX - startX;  
      }, {passive:true});  
  
      msgDiv.addEventListener("touchend", e => {  
        if (dist > threshold) {  
          setReplyMessage(msg, msgId);  
        }  
        dist = 0;  
      });  
  
      // Ø¯Ø¹Ù… Ø§Ù„Ù…Ø§ÙˆØ³ Ø£ÙŠØ¶Ø§Ù‹ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)  
      let mouseDownX = 0;  
      let mouseMoved = false;  
      msgDiv.addEventListener("mousedown", e => {  
        mouseDownX = e.clientX;  
        mouseMoved = false;  
      });  
      msgDiv.addEventListener("mousemove", e => {  
        if (e.buttons === 1) {  
          mouseMoved = true;  
          dist = e.clientX - mouseDownX;  
        }  
      });  
      msgDiv.addEventListener("mouseup", e => {  
        if (mouseMoved && dist > threshold) {  
          setReplyMessage(msg, msgId);  
        }  
        dist = 0;  
        mouseMoved = false;  
      });  
    }  
  
    // ØªØ¹ÙŠÙŠÙ† Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ø±Ø¯ ÙˆØ¥Ø¸Ù‡Ø§Ø±Ù‡Ø§ ÙÙˆÙ‚ Ù…Ø±Ø¨Ø¹ Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„  
    function setReplyMessage(msg, msgId) {  
      replyMessage = { ...msg, id: msgId };  
      showReplyUI();  
    }  
  
    // Ø¥Ù†Ø´Ø§Ø¡ ÙˆØ¥Ø¸Ù‡Ø§Ø± Ø¹Ù†ØµØ± Ø§Ù„Ø±Ø¯ ÙÙˆÙ‚ Ù…Ø±Ø¨Ø¹ Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„  
    function showReplyUI() {  
      clearReplyUI();  
      const inputContainer = document.getElementById("inputContainer");  
  
      const replyDiv = document.createElement("div");  
      replyDiv.id = "replyDiv";  
      replyDiv.style.background = "#f0e68c";  
      replyDiv.style.padding = "8px 12px";  
      replyDiv.style.borderRadius = "10px";  
      replyDiv.style.marginBottom = "6px";  
      replyDiv.style.position = "relative";  
      replyDiv.style.fontSize = "0.9rem";  
      replyDiv.style.color = "#444";  
      replyDiv.textContent = "Ø±Ø¯ Ø¹Ù„Ù‰: " + (replyMessage.text.length > 50 ? replyMessage.text.slice(0, 50) + "..." : replyMessage.text);  
  
      const cancelBtn = document.createElement("span");  
      cancelBtn.textContent = "Ã—";  
      cancelBtn.style.position = "absolute";  
      cancelBtn.style.left = "8px";  
      cancelBtn.style.top = "2px";  
      cancelBtn.style.cursor = "pointer";  
      cancelBtn.style.fontWeight = "bold";  
      cancelBtn.style.fontSize = "1.3rem";  
      cancelBtn.title = "Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø±Ø¯";  
      cancelBtn.onclick = () => {  
        replyMessage = null;  
        clearReplyUI();  
      };  
  
      replyDiv.appendChild(cancelBtn);  
      inputContainer.insertBefore(replyDiv, messageInput);  
    }  
  
    // Ø¥Ø²Ø§Ù„Ø© ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø±Ø¯ Ø¥Ù† ÙˆØ¬Ø¯Øª  
    function clearReplyUI() {  
    
