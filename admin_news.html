<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>إدارة الأخبار - VIBE Admin</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" crossorigin="anonymous" />

  <style>
    body { font-family: 'Cairo', sans-serif; margin:0; background:#f1f1f1; }
    .top-bar {
      background:#222; color:white; padding:10px 20px; text-align:center;
      font-size:22px; font-weight:bold;
    }

    .container {
      max-width:900px;
      margin:20px auto;
      padding:20px;
      background:white;
      border-radius:12px;
    }

    .news-card{
      background:#fdfdfd;
      padding:15px;
      margin-bottom:15px;
      border-radius:10px;
      text-align:right;
      border-left:6px solid #ffb700;
      position:relative;
    }

    .news-title{ font-weight:bold; font-size:18px; margin-bottom:8px; }
    .news-text{ font-size:15px; color:#444; margin-top:5px; }
    .news-img{ width:140px; border-radius:10px; margin-top:8px; display:block; }

    .btn{ padding:6px 12px; border:none; border-radius:8px; cursor:pointer; margin-left:5px; font-weight:bold; }
    .btn-edit{ background:#007bff; color:white; }
    .btn-edit:hover{ background:#0056b3; }
    .btn-delete{ background:#dc3545; color:white; }
    .btn-delete:hover{ background:#b02a37; }

    input[type="text"], textarea{ width:100%; padding:8px; margin:5px 0 10px; border-radius:6px; border:1px solid #ccc; font-family:'Cairo', sans-serif; }
    textarea{ resize:vertical; }
  </style>
</head>
<body>

  <div class="top-bar">إدارة الأخبار - VIBE Admin</div>

  <div class="container">
    <h3>إضافة خبر جديد</h3>
    <input type="text" id="newTitle" placeholder="عنوان الخبر" />
    <textarea id="newText" rows="4" placeholder="نص الخبر"></textarea>
    <label for="newImageFile">رفع صورة الخبر (اختياري)</label>
    <input type="file" id="newImageFile" accept="image/*" />
    <button class="btn btn-edit" onclick="addNews()">➕ إضافة الخبر</button>
  </div>

  <div class="container" id="newsList">
    <h3>قائمة الأخبار</h3>
  </div>

  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyAYcZ2_RjaI4fjP14QlqbUbL3rWvPPWnas",
      authDomain: "sheko-store.firebaseapp.com",
      databaseURL: "https://sheko-store-default-rtdb.firebaseio.com",
      projectId: "sheko-store",
      storageBucket: "sheko-store.appspot.com",
      messagingSenderId: "113892775847",
      appId: "1:113892775847:web:2aa4c11c3f5dd1d15f0882"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.database();

    auth.onAuthStateChanged(user=>{
      if(!user) location.href="login.html";
    });

    const newsList = document.getElementById("newsList");

    function addNews(){
      const title = document.getElementById("newTitle").value.trim();
      const text = document.getElementById("newText").value.trim();
      const fileInput = document.getElementById("newImageFile");
      if(!title || !text){
        alert("⚠️ الرجاء تعبئة العنوان والنص");
        return;
      }

      if(fileInput.files[0]){
        const reader = new FileReader();
        reader.onload = function(e){
          saveNews(title,text,e.target.result);
        };
        reader.readAsDataURL(fileInput.files[0]);
      } else {
        saveNews(title,text,"");
      }
    }

    function saveNews(title,text,image){
      const newNewsRef = db.ref("news").push();
      newNewsRef.set({
        title, text, image,
        timestamp: Date.now()   // مهم للترتيب
      }).then(()=>{
        document.getElementById("newTitle").value="";
        document.getElementById("newText").value="";
        document.getElementById("newImageFile").value="";
      });
    }

    function loadNews(){
      db.ref("news").orderByChild("timestamp").on("value", snap=>{
        newsList.innerHTML = "<h3>قائمة الأخبار</h3>";
        let arr=[];
        snap.forEach(child=>arr.push({key:child.key, ...child.val()}));
        arr.reverse(); // الأحدث أولاً

        arr.forEach(n=>{
          const div = document.createElement("div");
          div.className="news-card";
          div.innerHTML=`
            <div class="news-title">${n.title}</div>
            ${n.image ? `<img class="news-img" src="${n.image}">` : ""}
            <div class="news-text">${n.text}</div>
            <div style="margin-top:8px;">
              <button class="btn btn-edit" onclick="editNews('${n.key}')">تعديل</button>
              <button class="btn btn-delete" onclick="deleteNews('${n.key}')">حذف</button>
            </div>
          `;
          newsList.appendChild(div);
        });
      });
    }

    function deleteNews(key){
      if(confirm("هل أنت متأكد من حذف هذا الخبر؟")){
        db.ref("news/"+key).remove();
      }
    }

    function editNews(key){
      db.ref("news/"+key).once("value").then(snap=>{
        if(!snap.exists()) return;
        const data = snap.val();
        const newTitle = prompt("عدل عنوان الخبر:", data.title);
        if(newTitle===null) return;
        const newText = prompt("عدل نص الخبر:", data.text);
        if(newText===null) return;

        const fileInput = document.createElement("input");
        fileInput.type="file";
        fileInput.accept="image/*";
        fileInput.onchange = function(e){
          if(e.target.files[0]){
            const reader = new FileReader();
            reader.onload = function(ev){
              db.ref("news/"+key).update({
                title:newTitle,
                text:newText,
                image:ev.target.result,
                timestamp: Date.now()
              });
            };
            reader.readAsDataURL(e.target.files[0]);
          } else {
            db.ref("news/"+key).update({
              title:newTitle,
              text:newText,
              image:data.image,
              timestamp: Date.now()
            });
          }
        };
        fileInput.click();
      });
    }

    loadNews();
  </script>

</body>
</html>
