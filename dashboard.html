<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>لوحة التحكم - Dashboard</title>

  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f4f4f4;
      margin: 0; padding: 0;
      direction: rtl;
      text-align: right;
    }
    header {
      background: #007bff;
      color: white;
      padding: 15px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    header div, header button {
      font-weight: bold;
      cursor: pointer;
      user-select: none;
    }
    header #logout {
      background: #ff4d4d;
      padding: 6px 12px;
      border-radius: 4px;
      transition: background 0.3s ease;
    }
    header #logout:hover {
      background: #e04343;
    }
    header #infoAccountBtn {
      background: #28a745;
      border: none;
      color: white;
      padding: 6px 12px;
      border-radius: 4px;
      transition: background 0.3s ease;
    }
    header #infoAccountBtn:hover {
      background: #218838;
    }
    main {
      max-width: 600px;
      margin: 30px auto;
      background: white;
      padding: 20px 25px;
      border-radius: 8px;
      box-shadow: 0 0 8px rgba(0,0,0,0.1);
    }
    label {
      display: block;
      margin: 15px 0 8px;
      font-weight: bold;
      font-size: 16px;
    }
    select, input[type="text"], input[type="number"] {
      width: 100%;
      padding: 10px;
      border-radius: 5px;
      border: 1px solid #ccc;
      font-size: 15px;
      box-sizing: border-box;
    }
    button#sendOrderBtn {
      margin-top: 25px;
      width: 100%;
      padding: 14px;
      background: #007bff;
      border: none;
      color: white;
      font-size: 18px;
      font-weight: bold;
      border-radius: 6px;
      cursor: pointer;
      transition: background 0.3s ease;
    }
    button#sendOrderBtn:disabled {
      background: #aaa;
      cursor: not-allowed;
    }
    #pricesContainer div {
      margin: 10px 0;
    }
    #pricesContainer label {
      font-weight: normal;
      cursor: pointer;
    }
    #message {
      margin-top: 15px;
      color: red;
      font-weight: bold;
      min-height: 24px;
    }
    #contactUs {
      margin-top: 30px;
      font-size: 14px;
      text-align: center;
      color: #333;
    }
    #contactUs a {
      color: #007bff;
      text-decoration: none;
    }
    #contactUs a:hover {
      text-decoration: underline;
    }
  </style>
</head>
<body>

<header>
  <div id="logout">تسجيل الخروج</div>
  <div>رصيدك: <span id="userBalance">...</span> جنيه</div>
  <button id="infoAccountBtn">معلومات حسابك</button>
</header>

<main>
  <label for="serviceSelect">اختر الخدمة</label>
  <select id="serviceSelect" disabled>
    <option value="" disabled selected>جارٍ تحميل الخدمات...</option>
  </select>

  <div id="subServicesContainer" style="display:none;">
    <label for="subServiceSelect">الخدمات المتعلقة</label>
    <select id="subServiceSelect"></select>
  </div>

  <div id="pricesContainer" style="display:none; margin-top:15px;"></div>

  <label id="accountLabel" for="accountInput" style="display:none;"></label>
  <input type="text" id="accountInput" style="display:none;" placeholder="أدخل اسم الحساب أو الايدي" />

  <button id="sendOrderBtn" disabled>إرسال الطلب</button>

  <div id="message"></div>

  <div id="contactUs">
    إذا واجهت أي مشكلة راسلنا على الواتساب: <a href="https://wa.me/201099874914" target="_blank">01099874914</a>
  </div>
</main>

<script>
  // ----- إعداد Firebase -----
  const firebaseConfig = {
    apiKey: "AIzaSyAYcZ2_RjaI4fjP14QlqbUbL3rWvPPWnas",
  authDomain: "sheko-store.firebaseapp.com",
  databaseURL: "https://sheko-store-default-rtdb.firebaseio.com",
  projectId: "sheko-store",
  storageBucket: "sheko-store.firebasestorage.app",
  messagingSenderId: "113892775847",
  appId: "1:113892775847:web:2aa4c11c3f5dd1d15f0882",
  measurementId: "G-MQCQE3X077"
  };

  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.firestore();

  // متغيرات عناصر الصفحة
  const serviceSelect = document.getElementById('serviceSelect');
  const subServiceSelect = document.getElementById('subServiceSelect');
  const subServicesContainer = document.getElementById('subServicesContainer');
  const pricesContainer = document.getElementById('pricesContainer');
  const accountInput = document.getElementById('accountInput');
  const accountLabel = document.getElementById('accountLabel');
  const sendOrderBtn = document.getElementById('sendOrderBtn');
  const message = document.getElementById('message');
  const userBalanceSpan = document.getElementById('userBalance');
  const infoAccountBtn = document.getElementById('infoAccountBtn');
  const logoutBtn = document.getElementById('logout');

  let userBalance = 0;
  let currentUser = null;

  // بيانات الخدمات (ثابتة)
  const data = {
    games: {
      name: "شحن ألعاب",
      services: {
        "pubg": {name: "ببجي موبايل", prices: [
          {desc: "60 شده", price: 50},
          {desc: "300 شده", price: 250}
        ]},
        "cod": {name: "كود موبايل", prices: [
          {desc: "220 سي بي", price: 250}
        ]},
        "freefire": {name: "فري فاير", prices: [
          {desc: "100 جوهره", price: 70}
        ]},
        "fifa": {name: "فيفا موبايل", prices: [
          {desc: "20 كوينز", price: 40}
        ]}
      },
      accountLabel: "الأي دي الخاص بك"
    },
    tiktok: {
      name: "تيك توك",
      services: {
        "followers": {name: "زيادة المتابعين"},
        "likes": {name: "زيادة الإعجابات"}
      },
      accountLabel: "اسم الحساب"
    },
    youtube: {
      name: "يوتيوب",
      services: {
        "subs": {name: "زيادة المشتركين"},
        "views": {name: "زيادة المشاهدات"}
      },
      accountLabel: "اسم الحساب"
    },
    instagram: {
      name: "إنستجرام",
      services: {
        "followers": {name: "زيادة المتابعين"},
        "likes": {name: "زيادة الإعجابات"}
      },
      accountLabel: "اسم الحساب"
    }
  };

  // تهيئة الصفحة بعد تسجيل الدخول
  auth.onAuthStateChanged(user => {
    if (user) {
      currentUser = user;
      loadUserData(user.uid);
      loadServices();
    } else {
      window.location.href = 'login.html'; // غيرها حسب صفحة تسجيل الدخول عندك
    }
  });

  // تحميل بيانات المستخدم (الرصيد)
  function loadUserData(uid){
    db.collection('users').doc(uid).get()
      .then(doc => {
        if(doc.exists){
          userBalance = doc.data().balance || 0;
          userBalanceSpan.textContent = userBalance;
          serviceSelect.disabled = false;
        } else {
          // انشئ بيانات جديدة للمستخدم برصيد 0 مثلاً
          db.collection('users').doc(uid).set({balance: 0});
          userBalance = 0;
          userBalanceSpan.textContent = userBalance;
          serviceSelect.disabled = false;
        }
      })
      .catch(err => {
        console.error("خطأ تحميل بيانات المستخدم:", err);
        message.textContent = "خطأ في تحميل بيانات المستخدم.";
      });
  }

  // تحميل الخيارات للخدمات الرئيسية
  function loadServices(){
    serviceSelect.innerHTML = `<option value="" disabled selected>اختر الخدمة</option>`;
    for(let key in data){
      const option = document.createElement('option');
      option.value = key;
      option.textContent = data[key].name;
      serviceSelect.appendChild(option);
    }
  }

  // عند اختيار الخدمة الرئيسية
  serviceSelect.addEventListener('change', () => {
    clearMessage();
    const serviceKey = serviceSelect.value;
    if (!serviceKey) return resetForm();

    // عرض الخدمات الفرعية
    const services = data[serviceKey].services;
    subServiceSelect.innerHTML = "";
    for (const key in services) {
      const option = document.createElement('option');
      option.value = key;
      option.textContent = services[key].name;
      subServiceSelect.appendChild(option);
    }
    subServicesContainer.style.display = "block";

    pricesContainer.style.display = "none";
    pricesContainer.innerHTML = "";
    accountInput.value = "";
    accountInput.style.display = "none";
    accountLabel.style.display = "none";
    sendOrderBtn.disabled = true;
  });

  // عند اختيار الخدمة الفرعية
  subServiceSelect.addEventListener('change', () => {
    clearMessage();
    const serviceKey = serviceSelect.value;
    const subServiceKey = subServiceSelect.value;
    if (!serviceKey || !subServiceKey) return;

    if (serviceKey === "games") {
      const game = data.games.services[subServiceKey];
      pricesContainer.style.display = "block";
      pricesContainer.innerHTML = "<strong>اختر السعر:</strong><br/>";
      game.prices.forEach((item, index) => {
        const radioId = "priceOption" + index;
        pricesContainer.innerHTML += `
          <div>
            <input type="radio" name="priceOption" id="${radioId}" data-price="${item.price}" />
            <label for="${radioId}">${item.desc} - ${item.price} جنيه</label>
          </div>`;
      });

      accountLabel.textContent = data.games.accountLabel;
      accountLabel.style.display = "block";
      accountInput.style.display = "block";
      accountInput.placeholder = "أدخل " + data.games.accountLabel;

      document.querySelectorAll('input[name="priceOption"]').forEach(radio => {
        radio.addEventListener('change', validateForm);
      });

      accountInput.addEventListener('input', validateForm);

      sendOrderBtn.disabled = true;
    } else {
      pricesContainer.style.display = "none";
      pricesContainer.innerHTML = "";

      accountLabel.textContent = data[serviceKey].accountLabel;
      accountLabel.style.display = "block";
      accountInput.style.display = "block";
      accountInput.placeholder = "أدخل " + data[serviceKey].accountLabel;

      accountInput.addEventListener('input', validateForm);
      sendOrderBtn.disabled = true;
    }
  });

  // تحقق من صحة البيانات لتفعيل زر الإرسال
  function validateForm(){
    clearMessage();
    const serviceKey = serviceSelect.value;
    const subServiceKey = subServiceSelect.value;
    if (!serviceKey || !subServiceKey) {
      sendOrderBtn.disabled = true;
      return;
    }
    const accountValue = accountInput.value.trim();
    if (!accountValue) {
      sendOrderBtn.disabled = true;
      return;
    }
    if (serviceKey === "games") {
      const selectedPriceRadio = document.querySelector('input[name="priceOption"]:checked');
      if (!selectedPriceRadio) {
        sendOrderBtn.disabled = true;
        return;
      }
      const price = Number(selectedPriceRadio.getAttribute('data-price'));
      if (userBalance < price) {
        showMessage("رصيدك غير كافٍ لإتمام الطلب");
        sendOrderBtn.disabled = true;
        return;
      }
    }
    sendOrderBtn.disabled = false;
  }

  // إرسال الطلب
  sendOrderBtn.addEventListener('click', () => {
    clearMessage();

    if (!currentUser) {
      alert("يجب تسجيل الدخول أولاً");
      return;
    }

    const userId = currentUser.uid;
    const serviceKey = serviceSelect.value;
    const subServiceKey = subServiceSelect.value;
    const accountValue = accountInput.value.trim();
    let price = 0;

    if(serviceKey === 'games'){
      const selectedPriceRadio = document.querySelector('input[name="priceOption"]:checked');
      price = Number(selectedPriceRadio.getAttribute('data-price'));
    }

    if(userBalance < price){
      showMessage("رصيدك غير كافٍ لإتمام الطلب");
      return;
    }

    // إضافة الطلب في Firestore
    db.collection('orders').add({
      userId: userId,
      service: serviceKey,
      subService: subServiceKey,
      account: accountValue,
      price: price,
      status: "قيد التنفيذ",
      createdAt: firebase.firestore.FieldValue.serverTimestamp()
    })
    .then(() => {
      // تحديث الرصيد
      userBalance -= price;
      userBalanceSpan.textContent = userBalance;

      db.collection('users').doc(userId).update({balance: userBalance});
      alert("تم إرسال الطلب بنجاح!");
      resetForm();
    })
    .catch(err => {
      console.error("خطأ في إرسال الطلب:", err);
      showMessage("حدث خطأ أثناء إرسال الطلب، حاول مرة أخرى.");
    });
  });

  // زر معلومات الحساب
  infoAccountBtn.addEventListener('click', () => {
    alert(`معلومات حسابك:\nرصيدك الحالي: ${userBalance} جنيه\nيمكنك اختيار الخدمات وإرسال الطلب.`);
  });

  // تسجيل الخروج
  logoutBtn.addEventListener('click', () => {
    auth.signOut().then(() => {
      window.location.href = 'login.html';
    });
  });

  function showMessage(msg){
    message.textContent = msg;
  }
  function clearMessage(){
    message.textContent = "";
  }
  function resetForm(){
    serviceSelect.value = "";
    subServicesContainer.style.display = "none";
    subServiceSelect.innerHTML = "";
    pricesContainer.style.display = "none";
    pricesContainer.innerHTML = "";
    accountInput.value = "";
    accountInput.style.display = "none";
    accountLabel.style.display = "none";
    sendOrderBtn.disabled = true;
  }

</script>

</body>
</html>
