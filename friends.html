<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>قائمة الأصدقاء</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body {
      font-family: 'Cairo', sans-serif;
      background: linear-gradient(to top, #f0f2f5, #ffffff);
      padding: 20px;
      margin: 0;
    }
    .friend-box, .request-box {
      background: #fff;
      margin: 10px 0;
      padding: 15px;
      border-radius: 12px;
      box-shadow: 0 0 8px rgba(0,0,0,0.1);
      display: flex;
      align-items: center;
      justify-content: space-between;
      animation: fadeIn 0.5s ease-in-out;
    }
    .friend-info {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .friend-info img {
      width: 45px;
      height: 45px;
      border-radius: 50%;
      object-fit: cover;
    }
    .friend-actions button {
      margin: 0 4px;
      padding: 6px 10px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
    }
    .add-section {
      margin-bottom: 20px;
    }
    .add-section input {
      padding: 10px;
      width: 70%;
      border-radius: 10px;
      border: 1px solid #ccc;
    }
    .add-section button {
      padding: 10px 15px;
      background: #007bff;
      color: #fff;
      border: none;
      border-radius: 10px;
      cursor: pointer;
    }
    .my-id-box {
      margin: 10px 0;
      background: #e9f5ff;
      padding: 10px;
      border-radius: 12px;
      text-align: center;
      font-weight: bold;
      animation: fadeInDown 0.6s;
    }
    @keyframes fadeIn {
      from {opacity: 0; transform: translateY(20px);}
      to {opacity: 1; transform: translateY(0);}
    }
    @keyframes fadeInDown {
      from {opacity: 0; transform: translateY(-10px);}
      to {opacity: 1; transform: translateY(0);}
    }
  </style>
</head>
<body>

  <h2>👥 قائمة الأصدقاء</h2>

  <div class="my-id-box">
    ID الخاص بك: <span id="myId"></span>
    <button onclick="copyMyId()">📋 نسخ</button>
    <button onclick="shareMyId()">📤 مشاركة</button>
  </div>

  <div class="add-section">
    <input type="text" id="friendIdInput" placeholder="أدخل ID المستخدم" />
    <button onclick="searchUser()">بحث</button>
  </div>

  <div id="searchResult"></div>
  <h3>طلبات الصداقة:</h3>
  <div id="friendRequests"></div>

  <h3>أصدقاؤك:</h3>
  <div id="friendsList"></div>

  <!-- Firebase -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import {
      getDatabase, ref, get, set, onValue, update, push, remove
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";
    import {
      getAuth, onAuthStateChanged
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAYcZ2_RjaI4fjP14QlqbUbL3rWvPPWnas",
      authDomain: "sheko-store.firebaseapp.com",
      databaseURL: "https://sheko-store-default-rtdb.firebaseio.com",
      projectId: "sheko-store",
      storageBucket: "sheko-store.appspot.com",
      messagingSenderId: "113892775847",
      appId: "1:113892775847:web:2aa4c11c3f5dd1d15f0882"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const auth = getAuth(app);

    let currentUid = null;
    let currentUserId = null;

    onAuthStateChanged(auth, (user) => {
      if (user) {
        currentUid = user.uid;
        const userRef = ref(db, `users/${currentUid}`);
        onValue(userRef, snap => {
          if (snap.exists()) {
            currentUserId = snap.val().id || currentUid;
            document.getElementById("myId").innerText = currentUserId;
          }
        });
        loadFriendRequests();
        loadFriendsList();
      }
    });

    window.copyMyId = () => {
      navigator.clipboard.writeText(currentUserId).then(() => {
        alert("تم نسخ ID الخاص بك");
      });
    };

    window.shareMyId = () => {
      const text = `هذا هو ID الخاص بي على Sheko Store: ${currentUserId}`;
      navigator.share ? navigator.share({text}) : alert(text);
    };

    window.searchUser = async () => {
      const inputId = document.getElementById("friendIdInput").value.trim();
      const usersRef = ref(db, "users");
      const snap = await get(usersRef);
      let found = false;

      if (snap.exists()) {
        snap.forEach(child => {
          const data = child.val();
          if (data.id == inputId && child.key !== currentUid) {
            found = true;
            document.getElementById("searchResult").innerHTML = `
              <div class="friend-box">
                <div class="friend-info">
                  <img src="${data.photoURL || 'https://via.placeholder.com/45'}" />
                  <div>
                    <strong>${data.username || 'مستخدم'}</strong><br/>
                    <small>ID: ${data.id}</small>
                  </div>
                </div>
                <div>
                  <button onclick="sendRequest('${child.key}')">➕ إضافة</button>
                </div>
              </div>
            `;
          }
        });
      }
      if (!found) {
        document.getElementById("searchResult").innerHTML = "لم يتم العثور على المستخدم.";
      }
    };

    window.sendRequest = (toUid) => {
      const reqRef = ref(db, `friendRequests/${toUid}/${currentUid}`);
      set(reqRef, true);
      alert("📤 تم إرسال طلب الصداقة!");
    };

    function loadFriendRequests() {
      const reqRef = ref(db, `friendRequests/${currentUid}`);
      onValue(reqRef, async snap => {
        const container = document.getElementById("friendRequests");
        container.innerHTML = "";

        if (snap.exists()) {
          for (const fromUid in snap.val()) {
            const userSnap = await get(ref(db, `users/${fromUid}`));
            if (userSnap.exists()) {
              const data = userSnap.val();
              const box = document.createElement("div");
              box.className = "request-box";
              box.innerHTML = `
                <div class="friend-info">
                  <img src="${data.photoURL || 'https://via.placeholder.com/45'}" />
                  <div><strong>${data.username}</strong></div>
                </div>
                <div class="friend-actions">
                  <button onclick="acceptRequest('${fromUid}')">✅ قبول</button>
                  <button onclick="rejectRequest('${fromUid}')">❌ رفض</button>
                </div>
              `;
              container.appendChild(box);
            }
          }
        }
      });
    }

    window.acceptRequest = async (fromUid) => {
      await set(ref(db, `friends/${currentUid}/${fromUid}`), true);
      await set(ref(db, `friends/${fromUid}/${currentUid}`), true);
      await remove(ref(db, `friendRequests/${currentUid}/${fromUid}`));
      alert("👍 تم قبول الطلب");
    };

    window.rejectRequest = async (fromUid) => {
      await remove(ref(db, `friendRequests/${currentUid}/${fromUid}`));
      alert("🚫 تم رفض الطلب");
    };

    function loadFriendsList() {
      const frRef = ref(db, `friends/${currentUid}`);
      onValue(frRef, async snap => {
        const container = document.getElementById("friendsList");
        container.innerHTML = "";
        if (snap.exists()) {
          for (const fuid in snap.val()) {
            const userSnap = await get(ref(db, `users/${fuid}`));
            if (userSnap.exists()) {
              const data = userSnap.val();
              const box = document.createElement("div");
              box.className = "friend-box";
              box.innerHTML = `
                <div class="friend-info">
                  <img src="${data.photoURL || 'https://via.placeholder.com/45'}" />
                  <div><strong>${data.username}</strong></div>
                </div>
                <div class="friend-actions">
                  <button onclick="chatWith('${fuid}')">💬 دردشة</button>
                  <button onclick="blockUser('${fuid}')">🚫 حظر</button>
                </div>
              `;
              container.appendChild(box);
            }
          }
        }
      });
    }

    window.chatWith = (uid) => {
      alert("سيفتح صفحة الدردشة مع: " + uid);
      // redirect to: window.location.href = `chat.html?user=${uid}`;
    };

    window.blockUser = async (uid) => {
      await remove(ref(db, `friends/${currentUid}/${uid}`));
      await remove(ref(db, `friends/${uid}/${currentUid}`));
      alert("🚫 تم الحظر وإزالة الصداقة");
    };
  </script>
</body>
</html>
