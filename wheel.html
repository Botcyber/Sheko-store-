<!DOCTYPE html><html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>عجلة الحظ - Sheko Store</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    body {
      font-family: 'Cairo', sans-serif;
      margin: 0;
      background: linear-gradient(to bottom, #fff7e6, #ffe08a);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100vh;
      color: #222;
    }
    h1 {
      margin-bottom: 20px;
      font-size: 28px;
    }
    #wheel {
      width: 300px;
      height: 300px;
      border-radius: 50%;
      border: 10px solid #222;
      position: relative;
      overflow: hidden;
      box-shadow: 0 0 15px rgba(0,0,0,0.2);
    }
    .segment {
      position: absolute;
      width: 50%;
      height: 50%;
      background: #ffb700;
      transform-origin: 100% 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      text-align: center;
      font-weight: bold;
      color: #222;
      font-size: 14px;
    }
    #pointer {
      width: 0;
      height: 0;
      border-left: 20px solid transparent;
      border-right: 20px solid transparent;
      border-bottom: 30px solid #222;
      position: absolute;
      top: -30px;
      left: 50%;
      transform: translateX(-50%);
    }
    #spinBtn {
      margin-top: 30px;
      background: #222;
      color: white;
      padding: 12px 30px;
      border: none;
      border-radius: 25px;
      font-size: 16px;
      font-weight: bold;
      cursor: pointer;
      transition: background 0.3s;
    }
    #spinBtn:hover {
      background: #ffb700;
      color: #222;
    }
    #result {
      margin-top: 20px;
      font-size: 18px;
      font-weight: bold;
      color: green;
    }
  </style>
</head>
<body>
  <h1>جرب حظك اليوم!</h1>
  <div id="wheel-container" style="position: relative;">
    <div id="pointer"></div>
    <div id="wheel"></div>
  </div>
  <button id="spinBtn">تدوير العجلة (50 نقطة)</button>
  <div id="result"></div>  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyAYcZ2_RjaI4fjP14QlqbUbL3rWvPPWnas",
      authDomain: "sheko-store.firebaseapp.com",
      databaseURL: "https://sheko-store-default-rtdb.firebaseio.com",
      projectId: "sheko-store",
      storageBucket: "sheko-store.appspot.com",
      messagingSenderId: "113892775847",
      appId: "1:113892775847:web:2aa4c11c3f5dd1d15f0882"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.database();

    const wheel = document.getElementById('wheel');
    const spinBtn = document.getElementById('spinBtn');
    const resultEl = document.getElementById('result');

    let segments = [];
    let angles = [];
    let canSpin = false;
    let currentUser = null;

    auth.onAuthStateChanged(user => {
      if (!user) return location.href = 'index.html';
      currentUser = user;
      loadWheel();
    });

    function loadWheel() {
      db.ref('wheelSegments').once('value').then(snapshot => {
        const data = snapshot.val() || {};
        segments = Object.keys(data);
        if (segments.length === 0) {
          wheel.innerHTML = '<p style="text-align:center;margin-top:100px;">لم يتم ضبط خانات العجلة بعد</p>';
          return;
        }
        drawWheel();
        checkCooldown();
      });
    }

    function drawWheel() {
      wheel.innerHTML = '';
      const angleSize = 360 / segments.length;
      angles = [];
      segments.forEach((seg, i) => {
        const angle = i * angleSize;
        angles.push({ value: seg, from: angle, to: angle + angleSize });
        const div = document.createElement('div');
        div.className = 'segment';
        div.style.transform = `rotate(${angle}deg) skewY(-${90 - angleSize}deg)`;
        div.style.background = i % 2 === 0 ? '#ffe48a' : '#ffd047';
        div.textContent = seg;
        wheel.appendChild(div);
      });
    }

    function checkCooldown() {
      const spinRef = db.ref('wheelSpins/' + currentUser.uid);
      spinRef.once('value').then(snap => {
        const lastSpin = snap.val();
        const now = Date.now();
        if (!lastSpin || now - lastSpin >= 86400000) {
          canSpin = true;
        } else {
          const remaining = Math.ceil((86400000 - (now - lastSpin)) / 3600000);
          resultEl.textContent = `يمكنك التدوير بعد ${remaining} ساعة`;
          spinBtn.disabled = true;
        }
      });
    }

    spinBtn.addEventListener('click', () => {
      if (!canSpin) return;
      db.ref('users/' + currentUser.uid + '/points').once('value').then(snapshot => {
        const points = snapshot.val() || 0;
        if (points < 50) return alert('يجب أن يكون لديك 50 نقطة على الأقل');

        // تدوير
        const randomIndex = Math.floor(Math.random() * segments.length);
        const chosenSegment = segments[randomIndex];
        const rotation = 3600 + (360 / segments.length) * randomIndex;

        wheel.style.transition = 'transform 5s ease-out';
        wheel.style.transform = `rotate(-${rotation}deg)`;
        spinBtn.disabled = true;

        setTimeout(() => {
          resultEl.textContent = `مبروك! ربحت: ${chosenSegment}`;
          db.ref('wheelSpins/' + currentUser.uid).set(Date.now());
          db.ref('users/' + currentUser.uid + '/points').set(points - 50);

          const resultRef = db.ref('wheelResults').push();
          resultRef.set({
            user: currentUser.email,
            reward: chosenSegment,
            time: Date.now()
          });
        }, 5200);
      });
    });
  </script></body>
</html>
