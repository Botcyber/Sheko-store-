<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>غرفة دردشة خاصة</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <style>
    body {
      font-family: 'Cairo', sans-serif;
      background: #f1f1f1;
      margin: 0; padding: 20px;
      display: flex; flex-direction: column; height: 100vh;
    }
    header {
      background: #222;
      color: white;
      padding: 15px;
      text-align: center;
      font-size: 20px;
      font-weight: bold;
      position: relative;
    }
    .admin-label {
      background: #ffb700;
      color: #222;
      font-weight: bold;
      padding: 3px 8px;
      border-radius: 12px;
      font-size: 12px;
      margin-left: 10px;
      box-shadow: 0 0 8px #ffb700;
      display: inline-block;
      vertical-align: middle;
    }
    #messages {
      flex: 1;
      background: white;
      border-radius: 10px;
      padding: 15px;
      overflow-y: auto;
      margin: 15px 0;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }
    .message {
      margin-bottom: 12px;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .message img {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      object-fit: cover;
    }
    .message .username {
      font-weight: bold;
      min-width: 100px;
    }
    .message .text {
      background: #eee;
      padding: 10px 15px;
      border-radius: 15px;
      max-width: 70%;
      word-break: break-word;
    }
    #inputArea {
      display: flex;
      gap: 10px;
    }
    #inputMessage {
      flex: 1;
      padding: 10px;
      font-size: 16px;
      border-radius: 20px;
      border: 1px solid #ccc;
      outline: none;
    }
    #sendBtn {
      background: #222;
      border: none;
      color: white;
      padding: 10px 18px;
      font-weight: bold;
      border-radius: 20px;
      cursor: pointer;
      transition: background 0.3s;
    }
    #sendBtn:hover {
      background: #ffb700;
      color: #222;
    }
    #settingsBtn {
      position: absolute;
      top: 15px;
      right: 20px;
      background: #ffb700;
      border: none;
      border-radius: 50%;
      width: 30px;
      height: 30px;
      cursor: pointer;
      font-size: 18px;
      line-height: 30px;
      text-align: center;
      color: #222;
      box-shadow: 0 0 8px #ffb700;
    }
    #settingsPanel {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: white;
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 0 15px rgba(0,0,0,0.3);
      display: none;
      width: 300px;
      max-height: 80vh;
      overflow-y: auto;
      z-index: 1000;
    }
    #settingsPanel h3 {
      margin-top: 0;
      margin-bottom: 15px;
      text-align: center;
    }
    #membersList {
      max-height: 300px;
      overflow-y: auto;
    }
    .memberItem {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 10px;
      padding: 6px 8px;
      border: 1px solid #ddd;
      border-radius: 6px;
      background: #f9f9f9;
    }
    .memberItem img {
      width: 30px;
      height: 30px;
      border-radius: 50%;
      object-fit: cover;
      margin-right: 10px;
    }
    .memberInfo {
      display: flex;
      align-items: center;
      flex: 1;
    }
    .memberName {
      font-weight: bold;
      font-size: 14px;
    }
    .removeBtn {
      background: #e74c3c;
      border: none;
      color: white;
      padding: 4px 8px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 12px;
      transition: background 0.3s;
    }
    .removeBtn:hover {
      background: #c0392b;
    }
    #deleteRoomBtn {
      background:#e74c3c; 
      color:white; 
      border:none; 
      padding:10px; 
      border-radius:8px; 
      width:100%; 
      font-weight:bold; 
      cursor:pointer; 
      margin-top:15px; 
      display:none;
    }
    #closeSettings {
      background: #222;
      color: white;
      border: none;
      padding: 8px 15px;
      border-radius: 8px;
      cursor: pointer;
      margin-top: 10px;
      width: 100%;
      font-weight: bold;
      transition: background 0.3s;
    }
    #closeSettings:hover {
      background: #ffb700;
      color: #222;
    }
  </style>
</head>
<body>
  <header>
    <span id="roomTitle">جارٍ التحميل...</span>
    <button id="settingsBtn" title="إعدادات الغرفة" style="display:none;"><i class="fa fa-cog"></i></button>
  </header>
  <div id="messages"></div>
  <div id="inputArea">
    <input type="text" id="inputMessage" placeholder="اكتب رسالتك هنا..." autocomplete="off" />
    <button id="sendBtn"><i class="fa fa-paper-plane"></i> إرسال</button>
  </div>

  <!-- لوحة الإعدادات -->
  <div id="settingsPanel">
    <h3>إعدادات الغرفة</h3>
    <div id="membersList">جارٍ تحميل الأعضاء...</div>
    <button id="deleteRoomBtn">حذف الغرفة</button>
    <button id="closeSettings">إغلاق</button>
  </div>

  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyAYcZ2_RjaI4fjP14QlqbUbL3rWvPPWnas",
      authDomain: "sheko-store.firebaseapp.com",
      databaseURL: "https://sheko-store-default-rtdb.firebaseio.com",
      projectId: "sheko-store",
      storageBucket: "sheko-store.appspot.com",
      messagingSenderId: "113892775847",
      appId: "1:113892775847:web:2aa4c11c3f5dd1d15f0882"
    };
    firebase.initializeApp(firebaseConfig);

    const db = firebase.database();
    const auth = firebase.auth();
    let currentUser = null;
    let roomId = null;
    let roomData = null;

    const urlParams = new URLSearchParams(window.location.search);
    roomId = urlParams.get("roomId");
    if (!roomId) {
      alert("لم يتم تحديد الغرفة.");
      window.location.href = "all-chat-rooms.html";
    }

    const roomTitleEl = document.getElementById("roomTitle");
    const messagesEl = document.getElementById("messages");
    const inputMessageEl = document.getElementById("inputMessage");
    const sendBtn = document.getElementById("sendBtn");
    const settingsBtn = document.getElementById("settingsBtn");
    const settingsPanel = document.getElementById("settingsPanel");
    const membersList = document.getElementById("membersList");
    const closeSettingsBtn = document.getElementById("closeSettings");
    const deleteRoomBtn = document.getElementById("deleteRoomBtn");

    auth.onAuthStateChanged(user => {
      if (user) {
        currentUser = user;
        loadRoomData();
      } else {
        window.location.href = "login.html";
      }
    });

    function loadRoomData() {
      db.ref("chat_rooms/" + roomId).once("value").then(snapshot => {
        roomData = snapshot.val();
        if (!roomData) {
          alert("هذه الغرفة غير موجودة.");
          window.location.href = "all-chat-rooms.html";
          return;
        }

        let titleHtml = roomData.name;
        if (roomData.adminUid === currentUser.uid) {
          titleHtml += ' <span class="admin-label">Admin</span>';
          settingsBtn.style.display = "inline-block";
        }
        roomTitleEl.innerHTML = titleHtml;

        if (!roomData.users || !roomData.users[currentUser.uid]) {
          alert("أنت لست عضواً في هذه الغرفة.");
          window.location.href = "all-chat-rooms.html";
          return;
        }

        listenMessages();
      });
    }

    function listenMessages() {
      db.ref("chat_rooms/" + roomId + "/messages").on("value", snapshot => {
        const messages = snapshot.val();
        messagesEl.innerHTML = "";
        if (!messages) return;
        // جلب بيانات كل رسالة واظهارها
        // هنا لنعرض بشكل متزامن كل رسالة مع بيانات المستخدم
        const promises = [];
        for (const msgId in messages) {
          promises.push(db.ref("users/" + messages[msgId].uid).once("value").then(userSnap => {
            const userData = userSnap.val() || {};
            return { msg: messages[msgId], user: userData };
          }));
        }
        Promise.all(promises).then(results => {
          results.forEach(({ msg, user }) => {
            displayMessage(msg, user);
          });
          messagesEl.scrollTop = messagesEl.scrollHeight;
        });
      });
    }

    function displayMessage(msg, user) {
      const div = document.createElement("div");
      div.classList.add("message");

      const imgSrc = user.profileimage || "default-profile.png";
      let username = user.username || "مستخدم مجهول";

      if (roomData.adminUid === msg.uid) {
        username += ' <span class="admin-label">Admin</span>';
      }

      div.innerHTML = `
        <img src="${imgSrc}" alt="صورة المستخدم" />
        <div class="username">${username}</div>
        <div class="text">${escapeHtml(msg.text)}</div>
      `;
      messagesEl.appendChild(div);
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.appendChild(document.createTextNode(text));
      return div.innerHTML;
    }

    sendBtn.addEventListener("click", sendMessage);
    inputMessageEl.addEventListener("keypress", e => {
      if (e.key === "Enter") sendMessage();
    });

    function sendMessage() {
      const text = inputMessageEl.value.trim();
      if (!text) return;

      db.ref("users/" + currentUser.uid).once("value").then(snap => {
        const userInfo = snap.val() || {};
        const newMsgRef = db.ref("chat_rooms/" + roomId + "/messages").push();
        newMsgRef.set({
          uid: currentUser.uid,
          text: text,
          timestamp: Date.now()
        });
        inputMessageEl.value = "";
      });
    }

    settingsBtn.addEventListener("click", () => {
      settingsPanel.style.display = "block";
      loadMembers();

      if (currentUser.uid === roomData.adminUid) {
        deleteRoomBtn.style.display = "block";
      } else {
        deleteRoomBtn.style.display = "none";
      }
    });

    closeSettingsBtn.addEventListener("click", () => {
      settingsPanel.style.display = "none";
    });

    function loadMembers() {
      membersList.innerHTML = "جارٍ تحميل الأعضاء...";
      db.ref("chat_rooms/" + roomId + "/users").once("value").then(async snap => {
        const usersInRoom = snap.val();
        if (!usersInRoom) {
          membersList.innerHTML = "لا يوجد أعضاء.";
          return;
        }
        membersList.innerHTML = "";

        const userPromises = Object.keys(usersInRoom).map(uid => {
          return db.ref("users/" + uid).once("value").then(userSnap => {
            return { uid, data: userSnap.val() };
          });
        });

        const usersData = await Promise.all(userPromises);

        usersData.forEach(({ uid, data }) => {
          const div = document.createElement("div");
          div.classList.add("memberItem");

          div.innerHTML = `
            <div class="memberInfo">
              <img src="${data?.profileimage || "default-profile.png"}" alt="صورة العضو" />
              <div class="memberName">${data?.username || "مستخدم"}</div>
              ${uid === roomData.adminUid ? '<span class="admin-label" style="margin-left:10px;">Admin</span>' : ''}
            </div>
            ${(currentUser.uid === roomData.adminUid && uid !== roomData.adminUid) ? `<button class="removeBtn" data-uid="${uid}">إزالة</button>` : ""}
          `;
          membersList.appendChild(div);
        });

        document.querySelectorAll(".removeBtn").forEach(btn => {
          btn.addEventListener("click", () => {
            const removeUid = btn.getAttribute("data-uid");
            if (confirm("هل أنت متأكد من إزالة هذا العضو من الغرفة؟")) {
              db.ref(`chat_rooms/${roomId}/users/${removeUid}`).remove().then(() => {
                loadMembers();
              });
            }
          });
        });
      });
    }

    deleteRoomBtn.addEventListener("click", () => {
      if (confirm("هل أنت متأكد من حذف هذه الغرفة؟ سيتم حذف كل محتوياتها.")) {
        db.ref("chat_rooms/" + roomId).remove()
          .then(() => {
            alert("تم حذف الغرفة بنجاح.");
            window.location.href = "all-chat-rooms.html";
          })
          .catch(error => {
            alert("حدث خطأ أثناء حذف الغرفة: " + error.message);
          });
      }
    });
  </script>
</body>
</html>
