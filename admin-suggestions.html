<!DOCTYPE html><html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>لوحة تحكم التذاكر - Sheko Store</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet" />
  <style>
    body {
      font-family: 'Cairo', sans-serif;
      background: linear-gradient(135deg, #fdfbfb, #ebedee);
      padding: 20px;
      color: #333;
    }h2 {
  text-align: center;
  color: #00796b;
  margin-bottom: 20px;
}

.ticket-card {
  background: white;
  border-radius: 12px;
  box-shadow: 0 4px 15px rgba(0,0,0,0.1);
  margin: 15px auto;
  padding: 15px;
  max-width: 600px;
  transition: 0.3s ease;
  animation: fadeIn 0.6s ease-in;
  direction: ltr;
}

@keyframes fadeIn {
  from { opacity: 0; transform: translateY(20px); }
  to { opacity: 1; transform: translateY(0); }
}

.ticket-card:hover {
  transform: translateY(-5px);
}

.uid, .email, .time {
  font-size: 14px;
  color: #555;
}

.message {
  background: #f1f1f1;
  border-radius: 8px;
  padding: 10px;
  margin-top: 10px;
  white-space: pre-wrap;
}

.delete-btn {
  background: #d32f2f;
  color: white;
  border: none;
  padding: 6px 12px;
  border-radius: 6px;
  cursor: pointer;
  float: left;
  margin-top: 10px;
}

.delete-btn:hover {
  background: #b71c1c;
}

  </style>
</head>
<body>
  <h2>📋 التذاكر المقترحة من المستخدمين</h2>  <div style="text-align:center; margin-bottom: 20px;">
    <input id="filterInput" type="text" placeholder="🔎 ابحث بـ UID أو البريد..." 
           style="padding: 10px; width: 60%; max-width: 400px; border-radius: 8px; border: 1px solid #ccc;">
    <button onclick="applyFilter()" style="margin-right: 10px; padding: 10px 20px; border-radius: 8px; border: none; background: #00796b; color: white;">فلترة</button>
    <button onclick="resetFilter()" style="padding: 10px 20px; border-radius: 8px; border: none; background: #9e9e9e; color: white;">إزالة الفلترة</button>
  </div>  <div id="ticketsContainer">⏳ جاري التحميل...</div>  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getDatabase, ref, get, remove } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAYcZ2_RjaI4fjP14QlqbUbL3rWvPPWnas",
      authDomain: "sheko-store.firebaseapp.com",
      databaseURL: "https://sheko-store-default-rtdb.firebaseio.com",
      projectId: "sheko-store",
      storageBucket: "sheko-store.appspot.com",
      messagingSenderId: "113892775847",
      appId: "1:113892775847:web:2aa4c11c3f5dd1d15f0882"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const auth = getAuth(app);
    const container = document.getElementById("ticketsContainer");

    let allTickets = [];

    onAuthStateChanged(auth, async (user) => {
      if (!user) return container.innerHTML = "❌ يجب تسجيل الدخول.";
      await loadSuggestions();
    });

    async function loadSuggestions() {
      container.innerHTML = "⏳ جاري التحميل...";
      allTickets = [];

      const snap = await get(ref(db, "suggestions"));
      if (!snap.exists()) return container.innerHTML = "📭 لا توجد تذاكر حالياً.";

      const suggestions = snap.val();
      for (const userUid in suggestions) {
        const userSnap = await get(ref(db, "users/" + userUid));
        const email = userSnap.exists() ? (userSnap.val().email || "غير معروف") : "غير معروف";

        const userSuggestions = suggestions[userUid];
        for (const ticketId in userSuggestions) {
          const item = userSuggestions[ticketId];
          storeTicket(userUid, email, item, ticketId);
        }
      }

      renderTickets(allTickets);
    }

    function storeTicket(userUid, email, item, ticketId) {
      allTickets.push({
        uid: userUid,
        email: email,
        message: item.message,
        time: item.time,
        ticketId: ticketId
      });
    }

    function renderTickets(tickets) {
      container.innerHTML = "";
      tickets.forEach(t => {
        const div = document.createElement("div");
        div.className = "ticket-card";
        div.innerHTML = `
          <div class="uid">🆔 UID: ${t.uid}</div>
          <div class="email">📧 البريد الإلكتروني: ${t.email}</div>
          <div class="time">⏱️ الوقت: ${new Date(t.time).toLocaleString("ar-EG")}</div>
          <div class="message">💬 ${t.message}</div>
          <button class="delete-btn" onclick="deleteTicket('${t.uid}', '${t.ticketId}')">🗑️ حذف</button>
        `;
        container.appendChild(div);
      });
    }

    window.deleteTicket = async (uid, ticketId) => {
      if (confirm("هل أنت متأكد أنك تريد حذف هذه التذكرة؟")) {
        await remove(ref(db, `suggestions/${uid}/${ticketId}`));
        alert("✅ تم حذف التذكرة");
        loadSuggestions();
      }
    };

    window.applyFilter = () => {
      const keyword = document.getElementById("filterInput").value.toLowerCase();
      const filtered = allTickets.filter(t =>
        t.uid.toLowerCase().includes(keyword) ||
        t.email.toLowerCase().includes(keyword)
      );
      renderTickets(filtered);
    };

    window.resetFilter = () => {
      document.getElementById("filterInput").value = "";
      renderTickets(allTickets);
    };
  </script></body>
</html>
