<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>ÿØÿ±ÿØÿ¥ÿ© ÿßŸÑÿ¢ÿØŸÖŸÜ - Sheko Store</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet" />
  <style>
    body {
      font-family: 'Cairo', sans-serif;
      margin: 0;
      background: #121212;
      color: #eee;
      display: flex;
      flex-direction: column;
      height: 100vh;
      overflow: hidden;
    }
    header {
      background: #ffb700;
      color: #222;
      padding: 15px 20px;
      font-weight: bold;
      font-size: 24px;
      text-align: center;
      box-shadow: 0 2px 5px rgba(0,0,0,0.3);
      user-select: none;
    }
    #chatContainer {
      flex-grow: 1;
      display: flex;
      flex-direction: column;
      padding: 15px;
      overflow: hidden;
      background: linear-gradient(135deg, #1f1f1f, #2e2e2e);
      border-radius: 8px;
      margin: 10px;
      box-shadow: 0 0 15px #ffb700aa;
    }
    #messages {
      flex-grow: 1;
      overflow-y: auto;
      padding-right: 10px;
      margin-bottom: 10px;
      border-radius: 10px;
      background: #222;
      scrollbar-width: thin;
      scrollbar-color: #ffb700 #333;
      animation: fadeIn 1s ease forwards;
    }
    #messages::-webkit-scrollbar {
      width: 8px;
    }
    #messages::-webkit-scrollbar-track {
      background: #333;
      border-radius: 10px;
    }
    #messages::-webkit-scrollbar-thumb {
      background-color: #ffb700;
      border-radius: 10px;
    }
    .message {
      margin: 8px 0;
      max-width: 70%;
      padding: 12px 18px;
      border-radius: 25px;
      line-height: 1.4;
      position: relative;
      word-wrap: break-word;
      animation: slideUp 0.3s ease forwards;
      cursor: pointer;
      user-select: none;
      display: inline-block;
    }
    .message.admin {
      background: #ffb700;
      color: #222;
      margin-left: auto;
      border-bottom-right-radius: 6px;
    }
    .message.user {
      background: #444;
      color: #eee;
      margin-right: auto;
      border-bottom-left-radius: 6px;
    }
    .message .timestamp {
      display: block;
      font-size: 10px;
      color: #ccc;
      margin-top: 4px;
    }
    #inputArea {
      display: flex;
      gap: 10px;
      align-items: center;
      margin-top: 5px;
    }
    #replyInput {
      flex-grow: 1;
      padding: 10px 15px;
      border-radius: 30px;
      border: none;
      font-size: 16px;
      outline: none;
      background: #333;
      color: #eee;
      transition: box-shadow 0.3s;
    }
    #replyInput:focus {
      box-shadow: 0 0 10px #ffb700;
    }
    #sendBtn {
      background: #ffb700;
      border: none;
      color: #222;
      padding: 10px 20px;
      border-radius: 30px;
      cursor: pointer;
      font-weight: bold;
      transition: background 0.3s;
      flex-shrink: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
    }
    #sendBtn:hover {
      background: #ffaa00;
    }
    .btn-reply, .btn-delete, .btn-like, .btn-love {
      background: transparent;
      border: none;
      cursor: pointer;
      margin-left: 6px;
      font-size: 18px;
      color: #222;
      border-radius: 50%;
      padding: 4px;
      transition: background 0.3s, color 0.3s;
    }
    .btn-reply:hover, .btn-delete:hover {
      background: #222;
      color: #ffb700;
    }
    .btn-like:hover {
      color: #4caf50;
    }
    .btn-love:hover {
      color: #e91e63;
    }
    .reactions {
      margin-top: 4px;
      font-size: 20px;
      user-select: none;
    }
    .reactions span {
      margin-left: 10px;
      cursor: pointer;
      transition: transform 0.2s ease;
    }
    .reactions span:hover {
      transform: scale(1.2);
    }
    .reply-box {
      background: #333;
      border-radius: 15px;
      padding: 6px 10px;
      margin-top: 5px;
      font-size: 13px;
      color: #ccc;
    }
    @keyframes fadeIn {
      from {opacity: 0;}
      to {opacity: 1;}
    }
    @keyframes slideUp {
      from {transform: translateY(15px); opacity: 0;}
      to {transform: translateY(0); opacity: 1;}
    }
  </style>
</head>
<body>

<header>ÿØÿ±ÿØÿ¥ÿ© ÿ•ÿØÿßÿ±ÿ© ÿßŸÑŸÖŸàŸÇÿπ</header>

<div id="chatContainer">
  <div id="messages">ÿ¨ÿßÿ±Ÿç ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ±ÿ≥ÿßÿ¶ŸÑ...</div>
  <div id="inputArea">
    <input type="text" id="replyInput" placeholder="ÿßŸÉÿ™ÿ® ÿ±ÿ≥ÿßŸÑÿ™ŸÉ ŸáŸÜÿß..." autocomplete="off" />
    <button id="sendBtn" title="ÿ•ÿ±ÿ≥ÿßŸÑ"><i class="fa fa-paper-plane"></i></button>
  </div>
</div>

<!-- ÿµŸàÿ™ ÿßŸÑÿ•ÿØŸÖŸÜ sheko -->
<audio id="shekoSound" src="https://assets.mixkit.co/sfx/preview/mixkit-positive-notification-951.mp3" preload="auto"></audio>

<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>

<script>
  const firebaseConfig = {
    apiKey: "AIzaSyAYcZ2_RjaI4fjP14QlqbUbL3rWvPPWnas",
    authDomain: "sheko-store.firebaseapp.com",
    databaseURL: "https://sheko-store-default-rtdb.firebaseio.com",
    projectId: "sheko-store",
    storageBucket: "sheko-store.appspot.com",
    messagingSenderId: "113892775847",
    appId: "1:113892775847:web:2aa4c11c3f5dd1d15f0882"
  };
  firebase.initializeApp(firebaseConfig);

  const db = firebase.database();
  const messagesEl = document.getElementById('messages');
  const replyInput = document.getElementById('replyInput');
  const sendBtn = document.getElementById('sendBtn');
  let adminName = localStorage.getItem('adminName') || 'Admin';

  function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }

  function renderMessages(messages) {
    messagesEl.innerHTML = '';
    Object.entries(messages).forEach(([key, msg]) => {
      const div = document.createElement('div');
      div.classList.add('message', msg.sender === adminName ? 'admin' : 'user');

      let nameDisplay = msg.sender === 'sheko'
        ? `<strong style="color:#FFD700; text-shadow:0 0 10px gold;">${msg.sender}</strong>`
        : `<strong>${msg.sender}</strong>`;

      let content = `
        ${nameDisplay}<br>
        ${escapeHtml(msg.text)}<br>
        <small class="timestamp">${new Date(msg.timestamp).toLocaleString()}</small>
        <div class="reactions">
          <span class="btn-like" data-msgid="${key}">üëç</span>
          <span class="btn-love" data-msgid="${key}">‚ô•Ô∏è</span>
        </div>
      `;

      if (msg.sender === adminName) {
        content += `
          <button class="btn-reply" data-msgid="${key}"><i class="fa fa-reply"></i></button>
          <button class="btn-delete" data-msgid="${key}"><i class="fa fa-trash"></i></button>
        `;
      }

      div.innerHTML = content;
      messagesEl.appendChild(div);
    });
    messagesEl.scrollTop = messagesEl.scrollHeight;
    addActionListeners();
  }

  function addActionListeners() {
    document.querySelectorAll('.btn-delete').forEach(btn => {
      btn.onclick = e => {
        const id = e.currentTarget.dataset.msgid;
        if (confirm('ÿ≠ÿ∞ŸÅ ÿßŸÑÿ±ÿ≥ÿßŸÑÿ©ÿü')) {
          db.ref(`adminChatMessages/${id}`).remove();
        }
      };
    });
    document.querySelectorAll('.btn-reply').forEach(btn => {
      btn.onclick = e => {
        const id = e.currentTarget.dataset.msgid;
        db.ref(`adminChatMessages/${id}`).get().then(snapshot => {
          if (!snapshot.exists()) return;
          const text = snapshot.val().text;
          replyInput.value = `@ÿ±ÿØ ÿπŸÑŸâ: "${text}"\n`;
          replyInput.focus();
        });
      };
    });
    document.querySelectorAll('.btn-like').forEach(btn => {
      btn.onclick = e => reactToMessage(e.currentTarget.dataset.msgid, 'like');
    });
    document.querySelectorAll('.btn-love').forEach(btn => {
      btn.onclick = e => reactToMessage(e.currentTarget.dataset.msgid, 'love');
    });
  }

  function reactToMessage(msgId, reaction) {
    const reactionsRef = db.ref(`adminChatMessages/${msgId}/reactions`);
    reactionsRef.transaction(current => {
      if (!current) current = {};
      current[reaction] = (current[reaction] || 0) + 1;
      return current;
    });
  }

  function loadMessages() {
    const seenShekoMsgs = new Set();
    db.ref('adminChatMessages').on('child_added', snapshot => {
      const msg = snapshot.val();
      const id = snapshot.key;
      if (msg.sender === 'sheko' && !seenShekoMsgs.has(id)) {
        document.getElementById('shekoSound').play().catch(()=>{});
        seenShekoMsgs.add(id);
      }
      renderMessagesFromDatabase();
    });
  }

  function renderMessagesFromDatabase() {
    db.ref('adminChatMessages').once('value', snapshot => {
      const msgs = snapshot.val() || {};
      const formatted = {};
      Object.entries(msgs).forEach(([key, val]) => {
        let reactions = '';
        if (val.reactions) {
          if (val.reactions.like) reactions += ` üëç${val.reactions.like}`;
          if (val.reactions.love) reactions += ` ‚ô•Ô∏è${val.reactions.love}`;
        }
        formatted[key] = {
          sender: val.sender,
          text: val.text + reactions,
          timestamp: val.timestamp
        };
      });
      renderMessages(formatted);
    });
  }

  function sendMessage() {
    const text = replyInput.value.trim();
    if (!text) return;
    db.ref('adminChatMessages').push({
      sender: adminName,
      text,
      timestamp: Date.now()
    });
    replyInput.value = '';
  }

  sendBtn.addEventListener('click', sendMessage);
  replyInput.addEventListener('keydown', e => {
    if (e.key === 'Enter' && !e.shiftKey) {
      e.preventDefault();
      sendMessage();
    }
  });

  loadMessages();
</script>

</body>
</html>
