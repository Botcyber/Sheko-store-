<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ù…Ø´Ø§Ù‡Ø¯Ø© Ø§Ù„ÙÙŠØ¯ÙŠÙˆ</title>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
<style>
body {margin:0; background:#111; color:white; font-family:Arial; padding:20px;}
.video-wrapper {max-width:900px; margin:auto;}
video, iframe {width:100%; height:500px; border-radius:10px;}
h2 {margin-top:10px;}
.controls {margin:10px 0;}
.controls button {padding:8px 15px; margin-right:5px; border:none; border-radius:5px; cursor:pointer;}
#likeBtn {background:#ff4444; color:white;}
#dislikeBtn {background:#888; color:white;}
#likeBtn.active {background:#ff0000;}
#dislikeBtn.active {background:#555;}
.comment-section {margin-top:20px;}
#commentForm {display:none; margin-top:10px;}
#commentForm input, #commentForm textarea {width:100%; padding:10px; margin:5px 0; border-radius:5px; border:none;}
#commentForm button {padding:10px 15px; background:#ff0000; border:none; border-radius:5px; color:white; cursor:pointer;}
.comment-item {border-bottom:1px solid #444; padding:5px 0;}
.comment-item strong {color:#ff4444;}
</style>
</head>
<body>

<div class="video-wrapper">
  <div id="playerContainer"></div>
  <h2 id="videoTitle"></h2>
  <p>Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø´Ø§Ù‡Ø¯Ø§Øª: <span id="videoViews">0</span></p>

  <div class="controls">
    <button id="likeBtn">ğŸ‘ <span id="likeCount">0</span></button>
    <button id="dislikeBtn">ğŸ‘ <span id="dislikeCount">0</span></button>
    <button id="showCommentFormBtn">Ø¥Ø¶Ø§ÙØ© ØªØ¹Ù„ÙŠÙ‚</button>
  </div>

  <div id="commentForm">
    <input type="text" id="userName" placeholder="Ø§Ø³Ù…Ùƒ">
    <textarea id="userComment" rows="3" placeholder="ØªØ¹Ù„ÙŠÙ‚Ùƒ..."></textarea>
    <button onclick="addComment()">Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªØ¹Ù„ÙŠÙ‚</button>
  </div>

  <div class="comment-section">
    <h3>Ø§Ù„ØªØ¹Ù„ÙŠÙ‚Ø§Øª</h3>
    <div id="commentList"></div>
  </div>
</div>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyAYcZ2_RjaI4fjP14QlqbUbL3rWvPPWnas",
  authDomain: "sheko-store.firebaseapp.com",
  databaseURL: "https://sheko-store-default-rtdb.firebaseio.com",
  projectId: "sheko-store",
  storageBucket: "sheko-store.appspot.com",
  messagingSenderId: "113892775847",
  appId: "1:113892775847:web:2aa4c11c3f5dd1d15f0882"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

const urlParams = new URLSearchParams(window.location.search);
const videoId = urlParams.get('id');
const playerContainer = document.getElementById('playerContainer');
const videoTitle = document.getElementById('videoTitle');
const videoViews = document.getElementById('videoViews');
const likeBtn = document.getElementById('likeBtn');
const dislikeBtn = document.getElementById('dislikeBtn');
const likeCount = document.getElementById('likeCount');
const dislikeCount = document.getElementById('dislikeCount');
const showCommentFormBtn = document.getElementById('showCommentFormBtn');
const commentForm = document.getElementById('commentForm');
const commentList = document.getElementById('commentList');

let viewedVideos = JSON.parse(localStorage.getItem('viewedVideos') || '[]');
let likedVideos = JSON.parse(localStorage.getItem('likedVideos') || '[]');
let dislikedVideos = JSON.parse(localStorage.getItem('dislikedVideos') || '[]');

if(videoId){
  const videoRef = db.ref('videos/'+videoId);

  videoRef.once('value').then(snapshot=>{
    const data = snapshot.val();
    if(data){
      let embedHTML = '';
      if(data.video.includes("youtube.com") || data.video.includes("youtu.be")){
        let vid = "";
        if(data.video.includes("youtube.com/watch?v=")){
          vid = data.video.split("v=")[1].split("&")[0];
        } else if(data.video.includes("youtu.be/")){
          vid = data.video.split("youtu.be/")[1].split("?")[0];
        }
        embedHTML = `<iframe src="https://www.youtube.com/embed/${vid}?controls=1&modestbranding=1&rel=0&showinfo=0" frameborder="0"
        allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>`;
      } else {
        embedHTML = `<video src="${data.video}" controls autoplay></video>`;
      }
      playerContainer.innerHTML = embedHTML;
      videoTitle.innerText = data.title;

      // Ù…Ø´Ø§Ù‡Ø¯Ø© Ø§Ù„ÙÙŠØ¯ÙŠÙˆ
      if(!viewedVideos.includes(videoId)){
        videoRef.child('views').transaction(current=>(current||0)+1).then(()=>{
          viewedVideos.push(videoId);
          localStorage.setItem('viewedVideos', JSON.stringify(viewedVideos));
          videoRef.child('views').once('value').then(snap=>{videoViews.innerText = snap.val();});
        });
      } else {
        videoRef.child('views').once('value').then(snap=>{videoViews.innerText = snap.val();});
      }

      // Ø¹Ø±Ø¶ Ø§Ù„Ù„Ø§ÙŠÙƒØ§Øª ÙˆØ§Ù„Ø¯ÙŠØ³Ù„Ø§ÙŠÙƒØ§Øª
      likeCount.innerText = data.likes || 0;
      dislikeCount.innerText = data.dislikes || 0;

      // Ø¹Ø±Ø¶ Ø§Ù„ØªØ¹Ù„ÙŠÙ‚Ø§Øª Ù…Ø¨Ø§Ø´Ø±Ø©
      db.ref('videos/'+videoId+'/comments').on('value',snap=>{
        commentList.innerHTML = "";
        snap.forEach(c=>{
          const val = c.val();
          const div = document.createElement('div');
          div.className='comment-item';
          div.innerHTML = `<strong>${val.name}</strong>: ${val.comment}`;
          commentList.appendChild(div);
        });
      });

      // ÙˆØ¶Ø¹ Ø­Ø§Ù„Ø© Ø§Ù„Ù„Ø§ÙŠÙƒ ÙˆØ§Ù„Ø¯ÙŠØ³Ù„Ø§ÙŠÙƒ Ø¹Ù†Ø¯ Ø§Ù„ØªØ­Ù…ÙŠÙ„
      if(likedVideos.includes(videoId)) likeBtn.classList.add('active');
      if(dislikedVideos.includes(videoId)) dislikeBtn.classList.add('active');

    } else videoTitle.innerText='Ø§Ù„ÙÙŠØ¯ÙŠÙˆ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯';
  });

// Like button
likeBtn.addEventListener('click', ()=>{
  if(likedVideos.includes(videoId)){
    // Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ù„Ø§ÙŠÙƒ
    videoRef.child('likes').transaction(current=>{
      return Math.max((current||0)-1, 0); // Ù„Ø§ ÙŠÙ‚Ù„ Ø¹Ù† ØµÙØ±
    });
    likedVideos = likedVideos.filter(id=>id!==videoId);
    localStorage.setItem('likedVideos', JSON.stringify(likedVideos));
    likeBtn.classList.remove('active');
    likeCount.innerText = parseInt(likeCount.innerText)-1;
  } else {
    // Ø¥Ø¶Ø§ÙØ© Ù„Ø§ÙŠÙƒ
    videoRef.child('likes').transaction(current=>(current||0)+1);
    likedVideos.push(videoId);
    localStorage.setItem('likedVideos', JSON.stringify(likedVideos));
    likeBtn.classList.add('active');
    likeCount.innerText = parseInt(likeCount.innerText)+1;

    // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø¯ÙŠØ³Ù„Ø§ÙŠÙƒ Ø¥Ø°Ø§ Ù…ÙˆØ¬ÙˆØ¯
    if(dislikedVideos.includes(videoId)){
      videoRef.child('dislikes').transaction(current=>Math.max((current||0)-1,0));
      dislikedVideos = dislikedVideos.filter(id=>id!==videoId);
      localStorage.setItem('dislikedVideos', JSON.stringify(dislikedVideos));
      dislikeBtn.classList.remove('active');
      dislikeCount.innerText = parseInt(dislikeCount.innerText)-1;
    }
  }
});

// Dislike button
dislikeBtn.addEventListener('click', ()=>{
  if(dislikedVideos.includes(videoId)){
    // Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø¯ÙŠØ³Ù„Ø§ÙŠÙƒ
    videoRef.child('dislikes').transaction(current=>Math.max((current||0)-1,0));
    dislikedVideos = dislikedVideos.filter(id=>id!==videoId);
    localStorage.setItem('dislikedVideos', JSON.stringify(dislikedVideos));
    dislikeBtn.classList.remove('active');
    dislikeCount.innerText = parseInt(dislikeCount.innerText)-1;
  } else {
    // Ø¥Ø¶Ø§ÙØ© Ø¯ÙŠØ³Ù„Ø§ÙŠÙƒ
    videoRef.child('dislikes').transaction(current=>(current||0)+1);
    dislikedVideos.push(videoId);
    localStorage.setItem('dislikedVideos', JSON.stringify(dislikedVideos));
    dislikeBtn.classList.add('active');
    dislikeCount.innerText = parseInt(dislikeCount.innerText)+1;

    // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ù„Ø§ÙŠÙƒ Ø¥Ø°Ø§ Ù…ÙˆØ¬ÙˆØ¯
    if(likedVideos.includes(videoId)){
      videoRef.child('likes').transaction(current=>Math.max((current||0)-1,0));
      likedVideos = likedVideos.filter(id=>id!==videoId);
      localStorage.setItem('likedVideos', JSON.stringify(likedVideos));
      likeBtn.classList.remove('active');
      likeCount.innerText = parseInt(likeCount.innerText)-1;
    }
  }
});

  // Ø¹Ø±Ø¶ Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„ØªØ¹Ù„ÙŠÙ‚ Ø¹Ù†Ø¯ Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Ø²Ø±
  showCommentFormBtn.addEventListener('click', ()=>{
    commentForm.style.display = commentForm.style.display==='none'?'block':'none';
  });

} else videoTitle.innerText='Ù„Ù… ÙŠØªÙ… ØªØ­Ø¯ÙŠØ¯ ÙÙŠØ¯ÙŠÙˆ';

// Ø¥Ø¶Ø§ÙØ© ØªØ¹Ù„ÙŠÙ‚
function addComment(){
  const name = document.getElementById('userName').value.trim();
  const comment = document.getElementById('userComment').value.trim();
  if(!name || !comment){alert("ÙŠØ±Ø¬Ù‰ ÙƒØªØ§Ø¨Ø© Ø§Ù„Ø§Ø³Ù… ÙˆØ§Ù„ØªØ¹Ù„ÙŠÙ‚"); return;}
  const commentRef = db.ref('videos/'+videoId+'/comments').push();
  commentRef.set({name:name, comment:comment}).then(()=>{
    document.getElementById('userName').value="";
    document.getElementById('userComment').value="";
    commentForm.style.display='none';
  });
}
</script>

</body>
</html>
