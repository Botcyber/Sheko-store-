<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ù…Ø´Ø§Ù‡Ø¯Ø© Ø§Ù„ÙÙŠØ¯ÙŠÙˆ</title>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
<style>
body {margin:0; background:#111; color:white; font-family:Arial; padding:20px;}
.video-wrapper {max-width:900px; margin:auto;}
video, iframe {width:100%; height:500px; border-radius:10px;}
h2 {margin-top:10px;}
.controls {margin:10px 0;}
.controls button {padding:8px 15px; margin-right:5px; border:none; border-radius:5px; cursor:pointer;}
#likeBtn {background:#ff4444; color:white;}
#dislikeBtn {background:#888; color:white;}
#likeBtn.active {background:#ff0000;}
#dislikeBtn.active {background:#555;}
.comment-section {margin-top:20px;}
#commentForm {display:none; margin-top:10px;}
#commentForm input, #commentForm textarea {width:100%; padding:10px; margin:5px 0; border-radius:5px; border:none;}
#commentForm button {padding:10px 15px; background:#ff0000; border:none; border-radius:5px; color:white; cursor:pointer;}
.comment-item {border-bottom:1px solid #444; padding:5px 0;}
.comment-item strong {color:#ff4444;}
</style>
</head>
<body>

<div class="video-wrapper">
  <div id="playerContainer"></div>
  <h2 id="videoTitle"></h2>
  <p>Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø´Ø§Ù‡Ø¯Ø§Øª: <span id="videoViews">0</span></p>

  <div class="controls">
    <button id="likeBtn">ğŸ‘ <span id="likeCount">0</span></button>
    <button id="dislikeBtn">ğŸ‘ <span id="dislikeCount">0</span></button>
    <button id="showCommentFormBtn">Ø¥Ø¶Ø§ÙØ© ØªØ¹Ù„ÙŠÙ‚</button>
  </div>

  <div id="commentForm">
    <input type="text" id="userName" placeholder="Ø§Ø³Ù…Ùƒ">
    <textarea id="userComment" rows="3" placeholder="ØªØ¹Ù„ÙŠÙ‚Ùƒ..."></textarea>
    <button onclick="addComment()">Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªØ¹Ù„ÙŠÙ‚</button>
  </div>

  <div class="comment-section">
    <h3>Ø§Ù„ØªØ¹Ù„ÙŠÙ‚Ø§Øª</h3>
    <div id="commentList"></div>
  </div>
</div>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyAYcZ2_RjaI4fjP14QlqbUbL3rWvPPWnas",
  authDomain: "sheko-store.firebaseapp.com",
  databaseURL: "https://sheko-store-default-rtdb.firebaseio.com",
  projectId: "sheko-store",
  storageBucket: "sheko-store.appspot.com",
  messagingSenderId: "113892775847",
  appId: "1:113892775847:web:2aa4c11c3f5dd1d15f0882"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

const urlParams = new URLSearchParams(window.location.search);
const videoId = urlParams.get('id');

const playerContainer = document.getElementById('playerContainer');
const videoTitle = document.getElementById('videoTitle');
const videoViews = document.getElementById('videoViews');
const likeBtn = document.getElementById('likeBtn');
const dislikeBtn = document.getElementById('dislikeBtn');
const likeCount = document.getElementById('likeCount');
const dislikeCount = document.getElementById('dislikeCount');
const showCommentFormBtn = document.getElementById('showCommentFormBtn');
const commentForm = document.getElementById('commentForm');
const commentList = document.getElementById('commentList');

let viewedVideos = JSON.parse(localStorage.getItem('viewedVideos') || '[]');
let likedVideos = JSON.parse(localStorage.getItem('likedVideos') || '[]');
let dislikedVideos = JSON.parse(localStorage.getItem('dislikedVideos') || '[]');

if(videoId){
  const videoRef = db.ref('videos/'+videoId);

  // ØªØ­Ù…ÙŠÙ„ ÙƒÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø©
  videoRef.once('value').then(snapshot=>{
    const data = snapshot.val();
    if(data){
      // Ø¹Ø±Ø¶ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ
      let embedHTML = '';
      if(data.video.includes("youtube.com") || data.video.includes("youtu.be")){
        let vid = "";
        if(data.video.includes("youtube.com/watch?v=")){
          vid = data.video.split("v=")[1].split("&")[0];
        } else if(data.video.includes("youtu.be/")){
          vid = data.video.split("youtu.be/")[1].split("?")[0];
        }
        embedHTML = `<iframe src="https://www.youtube.com/embed/${vid}?controls=1&modestbranding=1&rel=0&showinfo=0" frameborder="0"
        allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>`;
      } else {
        embedHTML = `<video src="${data.video}" controls autoplay></video>`;
      }
      playerContainer.innerHTML = embedHTML;
      videoTitle.innerText = data.title;

      // Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø´Ø§Ù‡Ø¯Ø©
      if(!viewedVideos.includes(videoId)){
        videoRef.child('views').transaction(current=>(current||0)+1);
        viewedVideos.push(videoId);
        localStorage.setItem('viewedVideos', JSON.stringify(viewedVideos));
      }
      videoViews.innerText = data.views || 0;

      // Ø§Ù„Ø¥Ø¹Ø¬Ø§Ø¨Ø§Øª ÙˆØ§Ù„Ø¯ÙŠØ³Ù„Ø§ÙŠÙƒØ§Øª
      likeCount.innerText = data.likes || 0;
      dislikeCount.innerText = data.dislikes || 0;
      if(likedVideos.includes(videoId)) likeBtn.classList.add('active');
      if(dislikedVideos.includes(videoId)) dislikeBtn.classList.add('active');

      // Ø§Ù„ØªØ¹Ù„ÙŠÙ‚Ø§Øª (Ø¬Ø¯ÙŠØ¯Ø© Ø£Ø¹Ù„Ù‰)
      db.ref('videos/'+videoId+'/comments').on('value', snap=>{
        commentList.innerHTML = "";
        const comments = [];
        snap.forEach(c=>{
          comments.push(c.val());
        });
        comments.reverse().forEach(val=>{
          const div = document.createElement('div');
          div.className='comment-item';
          div.innerHTML = `<strong>${val.name}</strong>: ${val.comment}`;
          commentList.appendChild(div);
        });
      });
    } else videoTitle.innerText='Ø§Ù„ÙÙŠØ¯ÙŠÙˆ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯';
  });

  // Like button
  likeBtn.addEventListener('click', ()=>{
    videoRef.transaction(v=>{
      if(v){
        v.likes = v.likes||0;
        v.dislikes = v.dislikes||0;
        if(likedVideos.includes(videoId)){
          v.likes = Math.max(v.likes-1,0);
          likedVideos = likedVideos.filter(id=>id!==videoId);
          likeBtn.classList.remove('active');
        } else {
          v.likes += 1;
          likedVideos.push(videoId);
          likeBtn.classList.add('active');
          if(dislikedVideos.includes(videoId)){
            v.dislikes = Math.max(v.dislikes-1,0);
            dislikedVideos = dislikedVideos.filter(id=>id!==videoId);
            dislikeBtn.classList.remove('active');
          }
        }
      }
      return v;
    }).then(()=>{ 
      localStorage.setItem('likedVideos', JSON.stringify(likedVideos));
      localStorage.setItem('dislikedVideos', JSON.stringify(dislikedVideos));
      videoRef.once('value').then(snap=>{
        likeCount.innerText = snap.val().likes || 0;
        dislikeCount.innerText = snap.val().dislikes || 0;
      });
    });
  });

  // Dislike button
  dislikeBtn.addEventListener('click', ()=>{
    videoRef.transaction(v=>{
      if(v){
        v.likes = v.likes||0;
        v.dislikes = v.dislikes||0;
        if(dislikedVideos.includes(videoId)){
          v.dislikes = Math.max(v.dislikes-1,0);
          dislikedVideos = dislikedVideos.filter(id=>id!==videoId);
          dislikeBtn.classList.remove('active');
        } else {
          v.dislikes += 1;
          dislikedVideos.push(videoId);
          dislikeBtn.classList.add('active');
          if(likedVideos.includes(videoId)){
            v.likes = Math.max(v.likes-1,0);
            likedVideos = likedVideos.filter(id=>id!==videoId);
            likeBtn.classList.remove('active');
          }
        }
      }
      return v;
    }).then(()=>{
      localStorage.setItem('likedVideos', JSON.stringify(likedVideos));
      localStorage.setItem('dislikedVideos', JSON.stringify(dislikedVideos));
      videoRef.once('value').then(snap=>{
        likeCount.innerText = snap.val().likes || 0;
        dislikeCount.innerText = snap.val().dislikes || 0;
      });
    });
  });

  // Ø¹Ø±Ø¶ Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„ØªØ¹Ù„ÙŠÙ‚ Ø¹Ù†Ø¯ Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Ø²Ø±
  showCommentFormBtn.addEventListener('click', ()=>{
    commentForm.style.display = commentForm.style.display==='none'?'block':'none';
  });

} else videoTitle.innerText='Ù„Ù… ÙŠØªÙ… ØªØ­Ø¯ÙŠØ¯ ÙÙŠØ¯ÙŠÙˆ';

// Ø¥Ø¶Ø§ÙØ© ØªØ¹Ù„ÙŠÙ‚
function addComment(){
  const name = document.getElementById('userName').value.trim();
  const comment = document.getElementById('userComment').value.trim();
  if(!name || !comment){alert("ÙŠØ±Ø¬Ù‰ ÙƒØªØ§Ø¨Ø© Ø§Ù„Ø§Ø³Ù… ÙˆØ§Ù„ØªØ¹Ù„ÙŠÙ‚"); return;}
  const commentRef = db.ref('videos/'+videoId+'/comments').push();
  commentRef.set({name:name, comment:comment}).then(()=>{
    document.getElementById('userName').value="";
    document.getElementById('userComment').value="";
    commentForm.style.display='none';
  });
}
</script>

</body>
</html>
