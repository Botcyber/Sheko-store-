<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ù…Ø´Ø§Ù‡Ø¯Ø© Ø§Ù„ÙÙŠØ¯ÙŠÙˆ</title>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
<style>
body {margin:0; background:#111; color:white; font-family:Arial; padding:20px;}
.video-wrapper {max-width:900px; margin:auto;}
video, iframe {width:100%; height:500px; border-radius:10px;}
h2 {margin-top:10px;}
.controls button {padding:8px 15px; margin-right:5px; border:none; border-radius:5px; cursor:pointer; background:#ff0000; color:white;}
.controls button:hover {background:#cc0000;}
.likes {margin-top:10px;}
.likes button {margin-right:10px; padding:8px 12px; border:none; border-radius:5px; cursor:pointer;}
.comments {margin-top:20px; border-top:1px solid #444; padding-top:10px;}
.comment-form input, .comment-form textarea {width:100%; padding:10px; margin:5px 0; border-radius:5px; border:none;}
.comment-form button {padding:10px 15px; background:#ff0000; border:none; border-radius:5px; color:white; cursor:pointer;}
.comment-item {border-bottom:1px solid #444; padding:5px 0;}
.comment-item strong {color:#ff4444;}
</style>
</head>
<body>

<div class="video-wrapper">
  <div id="playerContainer"></div>
  <h2 id="videoTitle"></h2>
  <p>Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø´Ø§Ù‡Ø¯Ø§Øª: <span id="videoViews">0</span></p>

  <div class="likes">
    <button id="likeBtn">ğŸ‘ <span id="likeCount">0</span></button>
    <button id="dislikeBtn">ğŸ‘ <span id="dislikeCount">0</span></button>
  </div>

  <div class="comments">
    <h3>Ø§Ù„ØªØ¹Ù„ÙŠÙ‚Ø§Øª</h3>
    <div class="comment-form">
      <input type="text" id="userName" placeholder="Ø§Ø³Ù…Ùƒ">
      <textarea id="userComment" rows="3" placeholder="ØªØ¹Ù„ÙŠÙ‚Ùƒ..."></textarea>
      <button onclick="addComment()">Ø¥Ø¶Ø§ÙØ© ØªØ¹Ù„ÙŠÙ‚</button>
    </div>
    <div id="commentList"></div>
  </div>
</div>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyAYcZ2_RjaI4fjP14QlqbUbL3rWvPPWnas",
  authDomain: "sheko-store.firebaseapp.com",
  databaseURL: "https://sheko-store-default-rtdb.firebaseio.com",
  projectId: "sheko-store",
  storageBucket: "sheko-store.appspot.com",
  messagingSenderId: "113892775847",
  appId: "1:113892775847:web:2aa4c11c3f5dd1d15f0882"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

const urlParams = new URLSearchParams(window.location.search);
const videoId = urlParams.get('id');
const playerContainer = document.getElementById('playerContainer');
const videoTitle = document.getElementById('videoTitle');
const videoViews = document.getElementById('videoViews');
const likeBtn = document.getElementById('likeBtn');
const dislikeBtn = document.getElementById('dislikeBtn');
const likeCount = document.getElementById('likeCount');
const dislikeCount = document.getElementById('dislikeCount');
const commentList = document.getElementById('commentList');

const viewedVideos = JSON.parse(localStorage.getItem('viewedVideos') || '[]');
const likedVideos = JSON.parse(localStorage.getItem('likedVideos') || '[]');
const dislikedVideos = JSON.parse(localStorage.getItem('dislikedVideos') || '[]');

if(videoId){
  const videoRef = db.ref('videos/'+videoId);

  videoRef.once('value').then(snapshot=>{
    const data = snapshot.val();
    if(data){
      let embedHTML = '';
      if(data.video.includes("youtube.com") || data.video.includes("youtu.be")){
        let vid = "";
        if(data.video.includes("youtube.com/watch?v=")){
          vid = data.video.split("v=")[1].split("&")[0];
        } else if(data.video.includes("youtu.be/")){
          vid = data.video.split("youtu.be/")[1].split("?")[0];
        }
        embedHTML = `<iframe src="https://www.youtube.com/embed/${vid}?controls=1&modestbranding=1&rel=0&showinfo=0" frameborder="0"
        allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>`;
      } else {
        embedHTML = `<video src="${data.video}" controls autoplay></video>`;
      }
      playerContainer.innerHTML = embedHTML;
      videoTitle.innerText = data.title;

      // Ù…Ø´Ø§Ù‡Ø¯Ø© Ø§Ù„ÙÙŠØ¯ÙŠÙˆ
      if(!viewedVideos.includes(videoId)){
        videoRef.child('views').transaction(current=>(current||0)+1).then(()=>{
          viewedVideos.push(videoId);
          localStorage.setItem('viewedVideos', JSON.stringify(viewedVideos));
          videoRef.child('views').once('value').then(snap=>{videoViews.innerText = snap.val();});
        });
      } else {
        videoRef.child('views').once('value').then(snap=>{videoViews.innerText = snap.val();});
      }

      // Ø¹Ø±Ø¶ Ø§Ù„Ù„Ø§ÙŠÙƒØ§Øª ÙˆØ§Ù„Ø¯ÙŠØ³Ù„Ø§ÙŠÙƒØ§Øª
      likeCount.innerText = data.likes || 0;
      dislikeCount.innerText = data.dislikes || 0;

      // ØªØ¹Ù„ÙŠÙ‚ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ
      db.ref('videos/'+videoId+'/comments').on('value',snap=>{
        commentList.innerHTML = "";
        snap.forEach(c=>{
          const val = c.val();
          const div = document.createElement('div');
          div.className='comment-item';
          div.innerHTML = `<strong>${val.name}</strong>: ${val.comment}`;
          commentList.appendChild(div);
        });
      });

    } else videoTitle.innerText='Ø§Ù„ÙÙŠØ¯ÙŠÙˆ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯';
  });

  // Like button
  likeBtn.addEventListener('click', ()=>{
    if(likedVideos.includes(videoId)) return; // Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„Ø¥Ø¹Ø¬Ø§Ø¨ Ù…Ø±ØªÙŠÙ†
    videoRef.child('likes').transaction(current=>(current||0)+1);
    likedVideos.push(videoId);
    localStorage.setItem('likedVideos', JSON.stringify(likedVideos));
    likeCount.innerText = parseInt(likeCount.innerText)+1;
  });

  // Dislike button
  dislikeBtn.addEventListener('click', ()=>{
    if(dislikedVideos.includes(videoId)) return;
    videoRef.child('dislikes').transaction(current=>(current||0)+1);
    dislikedVideos.push(videoId);
    localStorage.setItem('dislikedVideos', JSON.stringify(dislikedVideos));
    dislikeCount.innerText = parseInt(dislikeCount.innerText)+1;
  });

}

// Ø¥Ø¶Ø§ÙØ© ØªØ¹Ù„ÙŠÙ‚
function addComment(){
  const name = document.getElementById('userName').value.trim();
  const comment = document.getElementById('userComment').value.trim();
  if(!name || !comment){alert("ÙŠØ±Ø¬Ù‰ ÙƒØªØ§Ø¨Ø© Ø§Ù„Ø§Ø³Ù… ÙˆØ§Ù„ØªØ¹Ù„ÙŠÙ‚"); return;}
  const commentRef = db.ref('videos/'+videoId+'/comments').push();
  commentRef.set({name:name, comment:comment}).then(()=>{
    document.getElementById('userName').value="";
    document.getElementById('userComment').value="";
  });
}
</script>

</body>
</html>
